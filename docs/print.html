<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Kingdom of DS Hacking</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item affix "><a href="index.html">Home</a></li><li class="chapter-item affix "><li class="part-title">Guides</li><li class="chapter-item "><div><strong aria-hidden="true">1.</strong> Generation IV</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><div><strong aria-hidden="true">1.1.</strong> Diamond and Pearl</div></li><li class="chapter-item "><div><strong aria-hidden="true">1.2.</strong> Platinum</div></li><li class="chapter-item "><div><strong aria-hidden="true">1.3.</strong> Heartgold and SoulSilver</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="gen4/hgss/guides/town_map/town_map.html"><strong aria-hidden="true">1.3.1.</strong> Editing the Town Map</a></li></ol></li><li class="chapter-item "><div><strong aria-hidden="true">1.4.</strong> Universal</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="gen4/universal/guides/script_weather.html"><strong aria-hidden="true">1.4.1.</strong> Setting the Weather from a Script(Platinum/HGSS)</a></li></ol></li></ol></li><li class="chapter-item "><div><strong aria-hidden="true">2.</strong> Generation V</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><div><strong aria-hidden="true">2.1.</strong> Black and White</div></li><li class="chapter-item "><div><strong aria-hidden="true">2.2.</strong> Black 2 and White 2</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="gen5/b2w2/guides/fairy/fairy.html"><strong aria-hidden="true">2.2.1.</strong> Fairy Type Insertion</a></li></ol></li><li class="chapter-item "><div><strong aria-hidden="true">2.3.</strong> Universal</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="gen5/universal/guides/code_injection/code_injection.html"><strong aria-hidden="true">2.3.1.</strong> Code Injection</a></li></ol></li></ol></li><li class="chapter-item "><div><strong aria-hidden="true">3.</strong> Universal</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="universal/guides/code_injection/code_injection.html"><strong aria-hidden="true">3.1.</strong> Code Injection</a></li><li class="chapter-item "><a href="universal/guides/sprite_indexing/indexing.html"><strong aria-hidden="true">3.2.</strong> Sprite Indexing</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="universal/guides/sprite_indexing/gimp/gimp.html"><strong aria-hidden="true">3.2.1.</strong> GIMP</a></li></ol></li></ol></li><li class="chapter-item "><li class="part-title">Resources</li><li class="chapter-item "><div><strong aria-hidden="true">4.</strong> Generation IV</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><div><strong aria-hidden="true">4.1.</strong> Diamond and Pearl</div></li><li class="chapter-item "><div><strong aria-hidden="true">4.2.</strong> Platinum</div></li><li class="chapter-item "><div><strong aria-hidden="true">4.3.</strong> Heartgold and SoulSilver</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><div><strong aria-hidden="true">4.3.1.</strong> Structures</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="gen4/hgss/structures/town_map/town_map_spots.html"><strong aria-hidden="true">4.3.1.1.</strong> Town Map Structures</a></li></ol></li></ol></li></ol></li><li class="chapter-item "><div><strong aria-hidden="true">5.</strong> Generation V</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><div><strong aria-hidden="true">5.1.</strong> Black and White</div></li><li class="chapter-item "><div><strong aria-hidden="true">5.2.</strong> Black 2 and White 2</div></li><li class="chapter-item "><div><strong aria-hidden="true">5.3.</strong> Universal</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><div><strong aria-hidden="true">5.3.1.</strong> Structures</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="gen5/universal/structures/field/zone_entities.html"><strong aria-hidden="true">5.3.1.1.</strong> Zone Entities</a></li></ol></li></ol></li></ol></li><li class="chapter-item "><div><strong aria-hidden="true">6.</strong> Universal</div></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Kingdom of DS Hacking</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="home"><a class="header" href="#home">Home</a></h1>
<p><a href="README.html">Home</a></p>
<h1 id="guides"><a class="header" href="#guides">Guides</a></h1>
<ul>
<li><a href="">Generation IV</a>
<ul>
<li><a href="">Diamond and Pearl</a></li>
<li><a href="">Platinum</a></li>
<li><a href="">Heartgold and SoulSilver</a>
<ul>
<li><a href="gen4/hgss/guides/town_map/town_map.html">Editing the Town Map</a></li>
</ul>
</li>
<li><a href="">Universal</a>
<ul>
<li><a href="gen4/universal/guides/script_weather.html">Setting the Weather from a Script<sup><em>(Platinum/HGSS)</em></sup></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="">Generation V</a>
<ul>
<li><a href="">Black and White</a></li>
<li><a href="">Black 2 and White 2</a>
<ul>
<li><a href="gen5/b2w2/guides/fairy/fairy.html">Fairy Type Insertion</a></li>
</ul>
</li>
<li><a href="">Universal</a>
<ul>
<li><a href="gen5/universal/guides/code_injection/code_injection.html">Code Injection</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="">Universal</a>
<ul>
<li><a href="universal/guides/code_injection/code_injection.html">Code Injection</a></li>
<li><a href="universal/guides/sprite_indexing/indexing.html">Sprite Indexing</a>
<ul>
<li><a href="universal/guides/sprite_indexing/gimp/gimp.html">GIMP</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="resources"><a class="header" href="#resources">Resources</a></h1>
<ul>
<li><a href="">Generation IV</a>
<ul>
<li><a href="">Diamond and Pearl</a></li>
<li><a href="">Platinum</a></li>
<li><a href="">Heartgold and SoulSilver</a>
<ul>
<li><a href="">Structures</a>
<ul>
<li><a href="gen4/hgss/structures/town_map/town_map_spots.html">Town Map Structures</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="">Generation V</a>
<ul>
<li><a href="">Black and White</a></li>
<li><a href="">Black 2 and White 2</a></li>
<li><a href="">Universal</a>
<ul>
<li><a href="">Structures</a>
<ul>
<li><a href="gen5/universal/structures/field/zone_entities.html">Zone Entities</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="">Universal</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="town-map-editing---hgss"><a class="header" href="#town-map-editing---hgss">Town Map Editing - HGSS</a></h1>
<blockquote>
<p>All research for this guide &amp; the writing was done by <a href="https://github.com/BluRosie">BluRose</a>.</p>
</blockquote>
<p>The Town Map in Heart Gold is located solely within the Poké Gear, a departure from some previous games where the Town Map is a key item that gets a very large area to mess around on.  Because of this, the region is actually relatively cramped to start out with--Kanto makes a few sacrifices to nicely fit into the 32x32 blocks that the game uses--every square that the town map has corresponds to a 32x32 grid block, hence the reason that glitches like tweaking work in Platinum to go out of bounds and access the islands for Shaymin, Darkrai, and Cresselia.</p>
<p>In this guide, I look to turn Johto &amp; a little of Kanto into Hoenn.  While the images are included here as examples of what you can do, I ask that you refrain from copying my images (at least while I am still an active hacker, actively developing for my own hack).  Otherwise, just let me know if you want to use resources and we can talk.</p>
<hr />
<h2 id="table-of-contents"><a class="header" href="#table-of-contents">Table of Contents</a></h2>
<ul>
<li><a href="gen4/hgss/guides/town_map/town_map.html#prerequisites">Prerequisites</a></li>
<li><a href="gen4/hgss/guides/town_map/town_map.html#part-1---graphics">Part 1 - Graphics</a>
<ul>
<li><a href="gen4/hgss/guides/town_map/town_map.html#protagonist-portraits">Protagonist Portraits</a></li>
<li><a href="gen4/hgss/guides/town_map/town_map.html#town-previews">Town Previews</a></li>
<li><a href="gen4/hgss/guides/town_map/town_map.html#town-map-graphics">Town Map Graphics</a></li>
</ul>
</li>
<li><a href="gen4/hgss/guides/town_map/town_map.html#part-2---overlay-101-hex-editing">Part 2 - Overlay 101 Hex Editing</a>
<ul>
<li><a href="gen4/hgss/guides/town_map/town_map.html#redgray-map-chunks-flight-spots">Red/Gray Map Chunks, Flight Spots</a></li>
<li><a href="gen4/hgss/guides/town_map/town_map.html#orange-selection-blocks">Orange Selection Blocks</a></li>
</ul>
</li>
<li><a href="gen4/hgss/guides/town_map/town_map.html#appendix">Appendix</a></li>
<li><a href="gen4/hgss/guides/town_map/town_map.html#todo">TODO</a></li>
</ul>
<h2 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites</a></h2>
<ul>
<li>Comfortability with hex editing (and I mean comfortability, this gets pretty intense) and interpreting data</li>
<li>Comfortability with Tinke</li>
</ul>
<h2 id="part-1---graphics"><a class="header" href="#part-1---graphics">Part 1 - Graphics</a></h2>
<p>First thing's first, the graphics are the easy part.  <code>a/1/4/4</code> contains all of the graphics for the Town Map.  These are all easily editable using Tinke--a tutorial for which will not be covered here.  Refer to Jay's tutorials on YouTube for a basics of graphics editing tutorial.</p>
<h3 id="protagonist-portraits"><a class="header" href="#protagonist-portraits">Protagonist Portraits</a></h3>
<p>Clicking on the NCLR file 0 and then the NCGR file 1 will give you the town map portraits and the selectors--set the width to 16 and the height to 232.  Here you can replace the protagonist mugshots with whatever you can fit in the 16x16 space that uses very few colors to keep the rest of the indicators the same.  The roamers are also here, all of the Beasts and the Lati twins--feel free to change those as your hack requires!</p>
<p><img src="gen4/hgss/guides/town_map/original_portraits.png" alt="" /></p>
<p>When saving, make sure to click replace palette or whatever the checkbox is.  The graphic I will use is this one:</p>
<p><img src="gen4/hgss/guides/town_map/new_portraits.png" alt="" /></p>
<p>You can even check out the portraits in the game if you repack the narc and resave the ROM:</p>
<p><img src="gen4/hgss/guides/town_map/new_portrait_in_game.png" alt="" /></p>
<h3 id="town-previews"><a class="header" href="#town-previews">Town Previews</a></h3>
<p>Clicking on the NCLR file 14, the NCGR file 12, and the NSCR file 13 (in that order to load resources properly for editing) will give the Town Previews.  These are the things shown along the top of the Poké Gear when the town is hovered over.  There are 20 of these slots available--as this serves the purposes for my hack, I haven't looked into expanding it, but may eventually.  Kanto and Johto combined give a lot of leeway in this sense.</p>
<p><img src="gen4/hgss/guides/town_map/old_previews.png" alt="" /></p>
<p>I've also been pretty careful about replacing old city maps with cities in my hack to ensure that every facet of this tutorial goes over well.  It requires a bit of planning, but will keep things nice and easy for you if you choose to edit the town map.  Editing that image and replacing the NSCR file with tiling encoding enabled will conclude the Town Previews.</p>
<p>I haven't personally done this for my hack yet, as I have yet to place the buildings in most cities, so I have yet to replace these graphics.  I may come back eventually and update this.</p>
<h3 id="town-map-graphics"><a class="header" href="#town-map-graphics">Town Map Graphics</a></h3>
<p>First we have to disable a few things from the town map code that copy over blank map parts before Kanto is unlocked.  We also make the entire region into Johto so that there are no issues dealing with the town map name changing:</p>
<pre><code>Limit the PokéGear selectable area - Overlay 101
0x307C - [max x coord selectable]
0xFC18 - [max x coord selectable] 00 [max x coord selectable] 00 [max x coord selectable] 00
For example, my FC18 looks like 1C 00 1C 00 1C 00
This is the normal PokéGear map area limiter.

The same byte sequence exists at 0x107FC, and is used for the Fly map--replace that one too.

Make no map replacement from right part of image before Kanto is unlocked - Overlay 101
0x3846 - 00 00 00 00 00 00
0x38D6 - 00 00
0x38E2 - 00 00

Allow the user to fly to any region (make ov101_021EA804 always return 1) - Overlay 101
0x30C4 - 01 20 70 47

Cianwood we just replace the areas as needed.  Not all that bad, no need to find the code for it.
</code></pre>
<p>Next we have to add in the Town Map blurbs that appear when you hover over the town in the PokéGear.  This is all done in a027 file 273, so you can either replace existing entries or add new ones entirely--it's all up to you.  Just keep track of which is which.</p>
<p>Furthermore, change the first two entries (<code>Kanto</code> and <code>Johto</code>) to both be the name of your region.  Here, I replace both of mine with <code>Hoenn</code>.</p>
<p>Here is the part where things get a little bit complicated.</p>
<p>Each selectable tile in the PokéGear corresponds to one map chunk in the overworld.  Each 32x32 overworld space is one selectable tile in the PokéGear--and you can verify this by forcing the ability to open the start menu in the Mystery Zone, even as you run around out there it still updates your position in the PokéGear.
This somewhat constrains what you can and can't do mapping-wise.  I know I have made a number of concessions when it comes to mapping my overworld (especially given that Hoenn seems to be broken into 20x20 chunks and the town map there doesn't care).</p>
<p>Clicking on NCLR file 23, NCGR file 10, and NSCR 11 will net this massive image.</p>
<p><img src="gen4/hgss/guides/town_map/old_town_map.png" alt="" /></p>
<p>This is a lot to take in at first.  We have the actual town map on top of the many little highlight sections at the bottom.  Here, we whip out a new town map for our new region in the top section:</p>
<p><img src="gen4/hgss/guides/town_map/town_map_red_area_done.png" alt="" /></p>
<p><em>Make sure that the top leftmost tile is just the transparent (first) color in the palette!</em>  Issues come up if you do not abide by this, and you'll think that everything is buggy until you realize that you just didn't do this.  This is just because of how Tinke does the tiling in the NSCR file.</p>
<p>As we can see as well, we need to take into account that the Safari Zone areas are blocked out first, so I make sure to replace those down in the bottom right as well.  Saving this image and reopening it in the ROM:</p>
<p><img src="gen4/hgss/guides/town_map/poke_gear_screen_red_area.png" alt="" /></p>
<p><em>This being a garbled mess is 100% expected!</em>  We still have to deal with tables.</p>
<p>Trust the process here, it will look better, but it isn't then worth it to stress about how it appears in game until we get through the final hex editing step.  The game does lots of tile swapping at run time.</p>
<p>From here, we add the gray areas to the overall image as well:</p>
<p><img src="gen4/hgss/guides/town_map/town_map_gray_area_done.png" alt="" /></p>
<p>Then we just need to add the highlighted orange areas to the image, or rather the ones that are missing (including the routes):</p>
<p><img src="gen4/hgss/guides/town_map/town_map_orange_area_done.png" alt="" /></p>
<p>Now we move to making this look alright in the game and into overlay 101.</p>
<h2 id="part-2---overlay-101-hex-editing"><a class="header" href="#part-2---overlay-101-hex-editing">Part 2 - Overlay 101 Hex Editing</a></h2>
<h3 id="redgray-map-chunks-flight-spots"><a class="header" href="#redgray-map-chunks-flight-spots">Red/Gray Map Chunks, Flight Spots</a></h3>
<p>Overlay 101 has a table governing replacing the red town chunks with the gray town chunks when the town hasn't been visited, and another governing the orange selected overlay that appears when you select a town chunk or route chunk.  The first table is at 0x10274 (0x021F79B4) of overlay 101, and has the format for each entry:</p>
<pre><code class="language-c">struct GearMapTownOverlay
{
    /* 0x0 */ u16 mapHeader;
    /* 0x2 */ u16 gateAppearance; // not sure
    /* 0x4 */ u8 entry; // maybe
    /* 0x5 */ u8 entry2; // maybe
    /* 0x6 */ u8 redX;
    /* 0x7 */ u8 redY;
    /* 0x8 */ u8 grayX;
    /* 0x9 */ u8 grayY;
    /* 0xA */ u8 townDimY:4; // msn
              u8 townDimX:4; // lsn
    /* 0xB */ u8 replacementDimY:4; // msn
              u8 replacementDimX:4; // lsn
    /* 0xC */ u8 offsetY:4; // msn
              u8 offsetX:4; // lsn
    /* 0xD */ u8 padding;
}; // entry size = 0xE
</code></pre>
<p>More in-depth structure description and the fields appear on <a href="gen4/hgss/guides/town_map/../../structures/town_map/town_map_spots.html">this other page</a>.</p>
<p>So let's look at this table, split up by entry (0xE in size):</p>
<pre><code>31 00 31 00 00 00 20 0B 00 14 11 33 11 00 
32 00 32 00 01 01 1F 07 05 14 22 44 11 00 
33 00 33 00 02 02 20 02 0A 14 22 44 11 00 
34 00 34 00 03 03 28 03 0F 14 22 44 11 00 
35 00 35 00 04 04 2C 07 14 14 11 33 11 00 
36 00 36 00 05 05 28 09 19 14 22 44 11 00 
37 00 37 00 06 06 25 07 1E 14 22 44 11 00 
38 00 38 00 07 07 25 0C 23 14 22 44 11 00 
39 00 39 00 08 08 20 0F 00 18 11 33 11 00 
3A 00 3A 00 09 FF 1C 06 00 00 11 00 00 00 
3B 00 3B 00 0A 09 28 06 05 18 22 44 11 00 
3C 00 3C 00 0B 0A 15 0C 0B 19 11 11 00 00 
43 00 43 00 0C 0B 10 0C 0F 18 12 34 11 00 
49 00 49 00 0D 0C 0E 07 14 18 22 43 10 00 
4A 00 4A 00 0E 0D 0C 0E 19 18 12 34 11 00 
4B 00 4B 00 0F 0E 05 0A 1E 18 21 43 11 00 
4C 00 4C 00 10 0F 09 0A 23 18 23 45 11 00 
4D 00 4D 00 11 10 08 07 00 1C 22 44 11 00 
4E 00 4E 00 12 11 0B 04 05 1C 22 44 11 00 
57 00 57 00 13 12 10 05 0A 1C 11 33 11 00 
59 00 59 00 15 13 14 04 0F 1C 22 44 11 00 
58 00 58 00 14 FF 0F 01 00 00 23 00 00 00 
5A 00 5A 00 16 FF 19 08 00 00 11 00 00 00 
AE 00 AE 00 1E FF 02 08 00 00 22 00 00 00 
10 01 9B 01 1B FF 06 06 00 00 22 00 00 00 
60 00 18 01 23 FF 0A 06 00 00 22 00 00 00 
7C 00 1E 00 21 FF 1C 07 00 00 21 00 00 00  
</code></pre>
<p>We can see that there are clearly patterns.</p>
<p>Further breaking it down and labeling the names based on the map headers:</p>
<pre><code>        mapHeader  gateHeader  entry   entry2  redX  redY  grayX  grayY  townDim  replDim  offsetPos  padding
[0x00]  31 00      31 00       00      00      20    0B    00     14     11       33       11         00       // pallet town
[0x01]  32 00      32 00       01      01      1F    07    05     14     22       44       11         00       // viridian town
[0x02]  33 00      33 00       02      02      20    02    0A     14     22       44       11         00       // pewter
[0x03]  34 00      34 00       03      03      28    03    0F     14     22       44       11         00       // cerulean
[0x04]  35 00      35 00       04      04      2C    07    14     14     11       33       11         00       // lavender
[0x05]  36 00      36 00       05      05      28    09    19     14     22       44       11         00       // vermilion
[0x06]  37 00      37 00       06      06      25    07    1E     14     22       44       11         00       // celadon
[0x07]  38 00      38 00       07      07      25    0C    23     14     22       44       11         00       // fuchsia
[0x08]  39 00      39 00       08      08      20    0F    00     18     11       33       11         00       // cinnabar
[0x09]  3A 00      3A 00       09      FF      1C    06    00     00     11       00       00         00       // indigo plateau
[0x0A]  3B 00      3B 00       0A      09      28    06    05     18     22       44       11         00       // saffron
[0x0B]  3C 00      3C 00       0B      0A      15    0C    0B     19     11       11       00         00       // new bark town
[0x0C]  43 00      43 00       0C      0B      10    0C    0F     18     12       34       11         00       // cherrygrove
[0x0D]  49 00      49 00       0D      0C      0E    07    14     18     22       43       10         00       // violet
[0x0E]  4A 00      4A 00       0E      0D      0C    0E    19     18     12       34       11         00       // azalea
[0x0F]  4B 00      4B 00       0F      0E      05    0A    1E     18     21       43       11         00       // cianwood
[0x10]  4C 00      4C 00       10      0F      09    0A    23     18     23       45       11         00       // goldenrod
[0x11]  4D 00      4D 00       11      10      08    07    00     1C     22       44       11         00       // olivine
[0x12]  4E 00      4E 00       12      11      0B    04    05     1C     22       44       11         00       // ecruteak
[0x13]  57 00      57 00       13      12      10    05    0A     1C     11       33       11         00       // mahogany
[0x14]  59 00      59 00       15      13      14    04    0F     1C     22       44       11         00       // blackthorn
[0x15]  58 00      58 00       14      FF      0F    01    00     00     23       00       00         00       // lake of rage
[0x16]  5A 00      5A 00       16      FF      19    08    00     00     11       00       00         00       // mt silver
[0x17]  AE 00      AE 00       1E      FF      02    08    00     00     22       00       00         00       // safari zone gate
[0x18]  10 01      9B 01       1B      FF      06    06    00     00     22       00       00         00       // battle frontier / gate is access
[0x19]  60 00      18 01       23      FF      0A    06    00     00     22       00       00         00       // national park / gate is pokeathlon dome
[0x1A]  7C 00      1E 00       21      FF      1C    07    00     00     21       00       00         00       // victory road / gate is route 26
</code></pre>
<p>Every city gets an <code>entry2</code> field filled out.  All the entries get an <code>entry1</code> field.  I do not know much about these--I just use the existing ones in an effort not to renovate anything that doesn't need renovated.</p>
<p>How do we interpret the <code>redX</code>, <code>redY</code>, <code>grayX</code>, and <code>grayY</code> fields? </p>
<p>Tiles form tilesets (NCGR) and are 8x8 pixels, with the idea being that the tilemap (NSCR) then &quot;maps&quot; the tiles to the overall image that Tinke lets you view.  The coordinate fields are all coordinates in the overall image that is dumped:</p>
<p><img src="gen4/hgss/guides/town_map/old_town_map_but_8x8_annotated.png" alt="" /></p>
<p>We can start to circle gray positions really nicely, but circling red positions seems to be weird (bear with me, the circles are red and gray respectively and are a little hard to see):</p>
<p><img src="gen4/hgss/guides/town_map/old_town_map_with_wrong_circles.png" alt="" /></p>
<p>Entries 0x00 (Pallet), 0x01 (Viridian), and 0x05 (Vermilion) are circled on the map using the raw coordinates.</p>
<p>For whatever reason, the red position fields are offset by 1 each.  So on the image, the <code>redX</code> field actually references a position of <code>redX - 1</code>.  The <code>redY</code> field then references a position of <code>redY + 1</code>--<code>redX</code> is one less than what it should be, and <code>redY</code> is one more than it should be.</p>
<p>The gray fields are not affected by this issue.  Circling the adjusted red ones, offset 1 left and 1 down:</p>
<p><img src="gen4/hgss/guides/town_map/old_town_map_with_right_circles.png" alt="" /></p>
<p>That shows the top left of each city and the place that its replaced with.</p>
<p>We can tell how much to circle by the <code>townDim</code> field.  The <code>townDim</code> field is just a byte where the significant nybble is the y dimension and the other the x dimension.  For example, the <code>townDim</code> for Azalea is <code>12</code>, showing a y dimension of 1 and an x dimension of 2.  The <code>replDim</code> byte is the dimension of the replacement (encoded similarly)--before you visit the place, it replaces the red on the town map with the gray below.  This byte is the dimensions of that area.  For example, the <code>replDim</code> byte for Goldenrod City is <code>45</code>, meaning that the gray replacement area of Goldenrod is on a 5 horizontal by 4 vertical area.  Finally, the <code>offsetPos</code> byte describes the x- and y-offset away from the base coordinate the town itself actually starts, once again similarly encoded in the nybbles.</p>
<p>Dissecting a full entry:</p>
<p>Entry <code>0x0D</code> corresponds to a map header of <code>49 00</code>--after converting from little endian--<code>0x49</code>.  This corresponds to a map header of Violet City.  The <code>gateHeader</code> also has the Violet City map header.
Its <code>entry1</code>--which I believe is something of a &quot;flight spot flag&quot;--is <code>0xD</code> with an <code>entry2</code>--which I believe is some sort of &quot;city visited&quot; flag--of <code>0xC</code>.
The <code>redX</code>, <code>redY</code> fields show it belonging here (after being adjusted with the 1 offsets), and the <code>grayX</code>, <code>grayY</code> position is circled as well.  The areas are both circled to account for <code>replDim</code>, with <code>townDim</code> being located inside of each at an offset of <code>offsetPos</code>.</p>
<p><img src="gen4/hgss/guides/town_map/old_town_map_violet_focus.png" alt="" /></p>
<p>I would strongly recommend making something like an Excel sheet or a Google Sheets workbook to keep track of all of this!  It allows for quick adjustments such that you know what each field is in addition to being something you can always keep open to reference.  Mine looks like this:</p>
<p><img src="gen4/hgss/guides/town_map/excel_town_map_red_gray.png" alt="" /></p>
<p>This can then just copy-paste the table into HxD or similar for easy updating and editing (especially on a ROM with entirely decompressed overlays).</p>
<p>My table looks like:</p>
<pre><code>        mapHeader  gateHeader  entry   entry2  redX  redY  grayX  grayY  townDim  replDim  offsetPos  padding
[0x00]  31 00      31 00       00      00      06    0C    00     14     11       33       11         00       // littleroot
[0x01]  32 00      32 00       01      01      06    0A    00     17     11       23       11         00       // oldale
[0x02]  33 00      33 00       02      02      02    05    03     14     22       44       11         00       // rustboro
[0x03]  34 00      34 00       03      03      11    0A    0A     17     11       33       11         00       // pacifidlog
[0x04]  35 00      35 00       04      04      04    0F    00     1C     11       33       11         00       // dewford
[0x05]  36 00      36 00       05      05      09    0A    03     18     22       44       11         00       // slateport
[0x06]  37 00      37 00       06      06      09    06    03     1C     12       34       11         00       // mauville
[0x07]  38 00      38 00       07      07      06    06    07     14     11       33       11         00       // verdanturf
[0x08]  39 00      39 00       08      08      07    03    07     17     11       33       11         00       // lavaridge
[0x09]  3A 00      3A 00       09      09      04    01    07     1A     11       33       11         00       // fallarbor
[0x0A]  3B 00      3B 00       0A      0A      0D    01    07     1D     11       33       11         00       // fortree
[0x0B]  3C 00      3C 00       0B      0B      11    03    0D     17     23       45       11         00       // lilycove
[0x0C]  43 00      43 00       0C      0C      17    04    0D     14     12       34       11         00       // mossdeep
[0x0D]  49 00      49 00       0D      0D      15    07    0A     14     11       33       11         00       // sootopolis
[0x0E]  4A 00      4A 00       0E      0E      1A    07    0A     1A     21       43       11         00       // ever grande
[0x0F]  4B 00      4B 00       0F      0F      03    0A    00     19     11       23       11         00       // petalburg (replaced cianwood)
[0x10]  4C 00      4C 00       10      10      0E    0E    0D     1B     11       33       11         00       // battle frontier
[0x11]  00 00      00 00       00      00      00    00    00     00     00       00       00         00       // empty
[0x12]  00 00      00 00       00      00      00    00    00     00     00       00       00         00       // empty
[0x13]  00 00      00 00       00      00      00    00    00     00     00       00       00         00       // empty
[0x14]  00 00      00 00       00      00      00    00    00     00     00       00       00         00       // empty
[0x15]  00 00      00 00       00      00      00    00    00     00     00       00       00         00       // empty
[0x16]  00 00      00 00       00      00      00    00    00     00     00       00       00         00       // empty
[0x17]  00 00      00 00       00      00      00    00    00     00     00       00       00         00       // empty
[0x18]  00 00      00 00       00      00      00    00    00     00     00       00       00         00       // empty
[0x19]  00 00      00 00       00      00      00    00    00     00     00       00       00         00       // empty
[0x1A]  00 00      00 00       00      00      00    00    00     00     00       00       00         00       // empty
</code></pre>
<p>Inserting into the ROM:</p>
<p><img src="gen4/hgss/guides/town_map/town_map_first_pass_in_rom.png" alt="" /></p>
<p>We can see that unregistered areas (Pacifidlog, Dewford, Lavaridge) are copied properly from their gray entries below.  All the red areas are also properly partitioned and are just fine when registered.</p>
<h3 id="orange-selection-blocks"><a class="header" href="#orange-selection-blocks">Orange Selection Blocks</a></h3>
<p>Next part:  The orange selection blocks.  Walking around the map will show that the old selection blocks are still there:</p>
<p><img src="gen4/hgss/guides/town_map/town_map_first_pass_in_rom_1.png" alt="" /></p>
<p>As previously mentioned, overlay 101 has another table.  This table is at 0xFC32 (0x021F7372) of overlay 101, and has the format for each entry:</p>
<pre><code class="language-c">struct GearMapTownSelectionOverlay
{
    /* 0x0 */ u16 mapHeader;
    /* 0x2 */ u8 baseX; // in poke gear position
    /* 0x3 */ u8 baseY; // in poke gear position
    /* 0x4 */ u8 dimY:4; // msn
              u8 dimX:4; // lsn
    /* 0x5 */ u8 flags;
    /* 0x6 */ u8 textEntry; // in a027 file 273
    /* 0x7 */ u8 flySpot;
    /* 0x8 */ u32 padding;
    /* 0xC */ u8 orangeBaseX; // in image
    /* 0xD */ u8 orangeBaseY; // in image
    /* 0xE */ u8 orangeDimX; // in image
    /* 0xF */ u8 orangeDimY; // in image
}; // size = 0x10
</code></pre>
<p>Note that I have yet to document what the flags do.  The <code>GearMapTownSelectionOverlay</code> is better documented as well <a href="gen4/hgss/guides/town_map/../../structures/town_map/town_map_spots.html">on this page</a>.</p>
<p>The table split up by entry:</p>
<pre><code>09 02 13 02 33 C0 41 00 00 00 00 00 00 00 00 00
33 01 18 10 33 C0 45 00 00 00 00 00 00 00 00 00
78 00 15 06 11 00 37 00 00 00 00 00 05 28 01 01
7B 00 11 0A 11 00 3A 00 00 00 00 00 0A 28 01 01
7B 00 13 0C 11 00 3A 00 00 00 00 00 0C 2C 01 01
7B 00 14 08 11 00 3A 00 00 00 00 00 0D 28 01 01
6E 00 0F 09 11 00 27 00 00 00 00 00 05 28 01 01
63 00 0E 0F 11 00 2E 00 00 00 00 00 08 2C 01 01
72 00 0D 10 11 00 2F 00 00 00 00 00 05 28 01 01
75 00 0B 10 11 00 34 00 00 00 00 00 05 2D 01 01
60 00 0A 08 22 44 2B 00 00 00 00 00 00 25 02 02
6F 00 0C 06 11 00 28 00 00 00 00 00 05 28 01 01
07 00 0B 06 11 00 2A 00 00 00 00 00 05 28 01 01
77 00 0E 07 11 00 36 00 00 00 00 00 05 28 01 01
79 00 07 0D 11 00 38 00 00 00 00 00 01 2E 01 01
...
</code></pre>
<details>
<summary>Further elaborating on the table (click for drop down!)</summary>
<p>This table is (somewhat) sporadically labeled, instead of being super in-depth.</p>
<pre><code>        mapHeader  baseX  baseY  dim  flags  textEntry  flySpot  padding      orangeBaseX  orangeBaseY  orangeDimX  orangeDimY
[0x00]  09 02      13     02     33   C0     41         00       00 00 00 00  00           00           00          00          // sinjoh ruins
[0x01]  33 01      18     10     33   C0     45         00       00 00 00 00  00           00           00          00          // s.s. aqua
[0x02]  78 00      15     06     11   00     37         00       00 00 00 00  05           28           01          01          // ice path
[0x03]  7B 00      11     0A     11   00     3A         00       00 00 00 00  0A           28           01          01          // dark cave 1
[0x04]  7B 00      13     0C     11   00     3A         00       00 00 00 00  0C           2C           01          01          // dark cave 2
[0x05]  7B 00      14     08     11   00     3A         00       00 00 00 00  0D           28           01          01          // dark cave 3
[0x06]  6E 00      0F     09     11   00     27         00       00 00 00 00  05           28           01          01
[0x07]  63 00      0E     0F     11   00     2E         00       00 00 00 00  08           2C           01          01
[0x08]  72 00      0D     10     11   00     2F         00       00 00 00 00  05           28           01          01
[0x09]  75 00      0B     10     11   00     34         00       00 00 00 00  05           2D           01          01
[0x0A]  60 00      0A     08     22   44     2B         00       00 00 00 00  00           25           02          02          // national park
[0x0B]  6F 00      0C     06     11   00     28         00       00 00 00 00  05           28           01          01
[0x0C]  07 00      0B     06     11   00     2A         00       00 00 00 00  05           28           01          01
[0x0D]  77 00      0E     07     11   00     36         00       00 00 00 00  05           28           01          01
[0x0E]  79 00      07     0D     11   00     38         00       00 00 00 00  01           2E           01          01
[0x0F]  7E 00      17     0E     11   00     3D         00       00 00 00 00  06           28           01          01
[0x10]  7C 00      1C     09     21   40     3B         00       00 00 00 00  03           25           01          02
[0x11]  93 00      20     07     11   00     3E         00       00 00 00 00  0F           29           01          01
[0x12]  6A 00      20     06     11   00     21         00       00 00 00 00  0F           28           01          01
[0x13]  6A 00      2A     0B     11   00     21         00       00 00 00 00  1C           2B           01          01
[0x14]  6B 00      24     05     11   00     22         00       00 00 00 00  06           28           01          01
[0x15]  91 00      28     05     11   00     23         00       00 00 00 00  05           28           01          01
[0x16]  6C 00      2C     06     11   00     24         00       00 00 00 00  1F           29           01          01
[0x17]  E9 01      2C     07     11   00     43         00       00 00 00 00  1F           2A           01          01
[0x18]  92 00      23     11     11   00     26         00       00 00 00 00  06           28           01          01
[0x19]  10 01      06     08     22   44     32         00       00 00 00 00  00           25           02          02
[0x1A]  DF 01      25     0E     11   00     25         00       00 00 00 00  05           28           01          01
[0x1B]  DC 00      09     0A     11   00     30         00       00 00 00 00  05           28           01          01
[0x1C]  31 00      20     0D     11   00     0A         01       00 00 00 00  00           20           03          03          // pallet town
[0x1D]  32 00      1F     09     22   44     0B         02       00 00 00 00  23           20           04          04          // viridian town
[0x1E]  33 00      20     04     22   44     0C         03       00 00 00 00  23           20           04          04          // pewter
[0x1F]  34 00      28     05     22   84     0D         04       00 00 00 00  12           20           04          04          // cerulean
[0x20]  35 00      2C     09     11   00     0E         05       00 00 00 00  00           20           03          03          // lavender
[0x21]  36 00      28     0B     22   44     0F         06       00 00 00 00  23           20           04          04          // vermilion
[0x22]  37 00      25     09     22   44     10         07       00 00 00 00  23           20           04          04          // celadon
[0x23]  38 00      25     0E     22   84     11         08       00 00 00 00  12           20           04          04          // fuchsia
[0x24]  39 00      20     11     11   00     12         09       00 00 00 00  00           20           03          03          // cinnabar
[0x25]  3B 00      28     08     22   44     14         0A       00 00 00 00  23           20           04          04          // saffron
[0x26]  3C 00      15     0E     11   00     15         0B       00 00 00 00  00           20           03          03          // new bark town
[0x27]  43 00      10     0E     12   04     16         0C       00 00 00 00  1A           20           04          03          // cherrygrove
[0x28]  49 00      0E     09     22   84     17         0D       00 00 00 00  0E           20           04          04          // violet
[0x29]  4A 00      0C     10     11   00     18         0E       00 00 00 00  16           20           04          03          // azalea
[0x2A]  4B 00      05     0C     21   40     19         0F       00 00 00 00  03           20           03          04          // cianwood
[0x2B]  4C 00      09     0C     23   48     1A         10       00 00 00 00  1E           20           05          04          // goldenrod
[0x2C]  4D 00      08     09     22   04     1B         11       00 00 00 00  06           20           04          04          // olivine
[0x2D]  4E 00      0B     06     22   84     1C         12       00 00 00 00  0A           20           04          04          // ecruteak
[0x2E]  57 00      10     07     11   00     1D         13       00 00 00 00  00           20           03          03          // mahogany
[0x2F]  59 00      14     06     22   84     1F         14       00 00 00 00  0E           20           04          04          // blackthorn
[0x30]  3A 00      1C     08     11   00     13         00       00 00 00 00  05           28           01          01          // indigo plateau
[0x31]  58 00      0F     03     23   48     1E         00       00 00 00 00  1E           20           05          04
[0x32]  5A 00      19     0A     11   00     39         00       00 00 00 00  05           28           01          01
[0x33]  08 00      0D     0A     21   40     2D         00       00 00 00 00  03           20           03          04
[0x34]  AE 00      02     0A     22   44     44         00       00 00 00 00  09           25           02          02
[0x35]  09 00      20     0B     21   40     46         00       00 00 00 00  0F           2E           01          02
[0x36]  0A 00      20     08     11   00     47         00       00 00 00 00  0F           2A           01          01
[0x37]  0B 00      22     05     12   04     48         00       00 00 00 00  19           28           02          01
[0x38]  0C 00      25     05     13   04     49         00       00 00 00 00  1C           28           03          01
[0x39]  0D 00      28     07     11   00     4A         00       00 00 00 00  19           2C           01          01
[0x3A]  0E 00      28     0A     11   00     4B         00       00 00 00 00  1A           2C           01          01
[0x3B]  0F 00      27     09     11   00     4C         00       00 00 00 00  18           2C           01          01
[0x3C]  10 00      2A     09     12   04     4D         00       00 00 00 00  1B           2C           02          01
[0x3D]  11 00      2A     06     12   04     4E         00       00 00 00 00  1D           29           02          01
[0x3E]  12 00      2C     08     11   00     4F         00       00 00 00 00  1F           2B           01          01
[0x3F]  13 00      2B     0B     11   00     50         00       00 00 00 00  1D           2B           01          01
[0x40]  14 00      2C     0A     31   40     51         00       00 00 00 00  1E           2A           01          03
[0x41]  15 00      2A     0D     13   04     52         00       00 00 00 00  1C           2D           03          01
[0x42]  16 00      2A     0E     21   40     53         00       00 00 00 00  1C           2E           01          02
[0x43]  17 00      27     0F     13   0C     54         00       00 00 00 00  19           2F           03          01
[0x44]  18 00      23     0A     12   04     55         00       00 00 00 00  17           28           02          01
[0x45]  19 00      23     0B     41   C0     56         00       00 00 00 00  17           29           01          04          // 
[0x46]  1A 00      23     0F     12   04     57         00       00 00 00 00  17           2D           02          01
[0x47]  5B 00      25     10     21   40     58         00       00 00 00 00  16           2D           01          02
[0x48]  5C 00      21     11     14   08     59         00       00 00 00 00  12           2E           04          01
[0x49]  5D 00      20     0E     31   C0     5A         00       00 00 00 00  11           2D           01          03          // 
[0x4A]  1B 00      1D     0A     12   04     5B         00       00 00 00 00  15           28           02          01
[0x4B]  1C 00      29     04     11   00     5D         00       00 00 00 00  18           2A           01          01
[0x4C]  1D 00      29     03     14   0C     5E         00       00 00 00 00  18           29           04          01
[0x4D]  1E 00      1C     0B     41   C0     5F         00       00 00 00 00  14           29           01          04          // 
[0x4E]  1F 00      16     0E     16   0F     60         00       00 00 00 00  0E           2C           06          01
[0x4F]  20 00      1A     0A     12   04     61         00       00 00 00 00  12           28           02          01
[0x50]  21 00      12     0E     13   0C     62         00       00 00 00 00  0B           2E           03          01
[0x51]  22 00      11     0B     31   40     63         00       00 00 00 00  0A           29           01          03
[0x52]  23 00      10     0A     12   01     64         00       00 00 00 00  09           28           01          01
[0x53]  24 00      0E     0B     41   C0     65         00       00 00 00 00  08           28           01          04
[0x54]  25 00      0E     10     11   00     66         00       00 00 00 00  08           2D           01          01
[0x55]  26 00      0B     0E     31   40     67         00       00 00 00 00  05           2B           01          02
[0x56]  27 00      0B     0A     21   40     68         00       00 00 00 00  02           2D           01          02
[0x57]  28 00      0B     09     13   04     69         00       00 00 00 00  02           2C           03          01
[0x58]  29 00      0C     08     11   00     6A         00       00 00 00 00  03           2B           01          01
[0x59]  2A 00      09     07     12   04     6B         00       00 00 00 00  01           28           02          01
[0x5A]  2B 00      08     07     21   40     6C         00       00 00 00 00  00           28           01          02
[0x5B]  5E 00      07     0A     21   40     6D         00       00 00 00 00  01           2A           01          02
[0x5C]  5F 00      06     0C     22   04     6E         00       00 00 00 00  00           2C           02          02
[0x5D]  2C 00      0D     07     13   02     6F         00       00 00 00 00  02           2A           03          01
[0x5E]  2D 00      10     05     21   40     70         00       00 00 00 00  03           28           01          02
[0x5F]  2E 00      11     07     13   08     71         00       00 00 00 00  05           2A           03          01
[0x60]  2F 00      14     09     41   80     72         00       00 00 00 00  0D           29           01          04
[0x61]  30 00      13     0D     21   00     73         00       00 00 00 00  0C           2D           01          01
[0x62]  97 00      02     0D     23   48     74         00       00 00 00 00  20           29           03          02
[0x63]  98 00      02     0C     12   04     75         00       00 00 00 00  20           28           02          01
</code></pre>
</details>
<p>These are all as simple as the table makes it seem.  When anywhere within the coordinates <code>(baseX+dimX, baseY+dimY)</code>, the PokéGear will select the entire orange area as specified on the image by the area <code>(orangeBaseX+orangeDimX, orangeBaseY+orangeDimY)</code>.</p>
<p>This can also similarly be broken down into a nice spreadsheet for easy editing and pasting into the ROM.  I actually include mine as a <a href="gen4/hgss/guides/town_map/town_map_blocks.xlsx">template for you to download</a>.  My entries look something like this (each commented):</p>
<pre><code>        mapHeader  baseX  baseY  dim  flags  textEntry  flySpot  padding      orangeBaseX  orangeBaseY  orangeDimX  orangeDimY
[0x00]  31 00      06     0E     11   00     0A         01       00 00 00 00  00           20           03          03          // littleroot
[0x01]  32 00      06     0C     11   00     0B         02       00 00 00 00  00           20           03          03          // oldale
[0x02]  33 00      02     07     22   00     0C         03       00 00 00 00  23           20           04          04          // rustboro
[0x03]  34 00      11     0C     11   00     0D         04       00 00 00 00  00           20           03          03          // pacifidlog
[0x04]  35 00      04     11     11   00     0E         05       00 00 00 00  00           20           03          03          // dewford
[0x05]  36 00      09     0C     22   00     0F         06       00 00 00 00  23           20           04          04          // slateport
[0x06]  37 00      09     08     12   00     10         07       00 00 00 00  1A           20           04          03          // mauville
[0x07]  38 00      06     08     11   00     11         08       00 00 00 00  00           20           03          03          // verdanturf
[0x08]  39 00      07     05     11   00     12         09       00 00 00 00  00           20           03          03          // lavaridge
[0x09]  3B 00      0D     03     11   00     14         0A       00 00 00 00  00           20           03          03          // fortree
[0x0A]  3C 00      11     05     23   00     15         0B       00 00 00 00  1E           20           05          04          // lilycove
[0x0B]  43 00      17     06     12   00     16         0C       00 00 00 00  1A           20           04          03          // mossdeep
[0x0C]  49 00      15     09     11   00     17         0D       00 00 00 00  00           20           03          03          // sootopolis
[0x0D]  4A 00      1A     09     21   00     18         0E       00 00 00 00  0C           24           03          04          // ever grande
[0x0E]  4B 00      03     0C     11   00     19         0F       00 00 00 00  00           20           03          03          // petalburg
[0x0F]  3A 00      04     03     11   00     13         10       00 00 00 00  00           20           03          03          // fallarbor
[0x10]  4C 00      0E     10     11   00     1A         11       00 00 00 00  00           20           03          03          // battle frontier
</code></pre>
<p>The rest of them are 00'd out to ensure that nothing is displayed in the PokéGear.</p>
<p>Note that I haven't done the routes yet, but the cities are there to demonstrate functionality.  As an example, my Rustboro city is at <code>(2, 7)</code> on the map, has a selectable dimension of 2x2, uses text entry as a blurb <code>0x0C</code> from a027/273 on the top screen when selected, and uses fly spot 2.
Furthermore, the orange block that shows it is highlighted is located at <code>(0x23, 0x20)</code> on the massive town map image from earlier and is 4x4 in size.</p>
<p>Putting everything together, we can run through the map rather nicely:</p>
<p><img src="gen4/hgss/guides/town_map/final_town_map.png" alt="" /> <img src="gen4/hgss/guides/town_map/final_town_map_1.png" alt="" /> <img src="gen4/hgss/guides/town_map/final_town_map_2.png" alt="" /> <img src="gen4/hgss/guides/town_map/final_fly_map.png" alt="" /> <img src="gen4/hgss/guides/town_map/final_fly_map_1.png" alt="" /> <img src="gen4/hgss/guides/town_map/final_fly_map_2.png" alt="" /></p>
<h2 id="todo"><a class="header" href="#todo">TODO</a></h2>
<ul>
<li><code>flags</code> field in <code>GearMapTownSelectionOverlay</code></li>
<li>PokéDex Map Editing</li>
<li>Roamer Maps Possible</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="setting-the-weather-from-a-script-platinumhgss"><a class="header" href="#setting-the-weather-from-a-script-platinumhgss">Setting the Weather From a Script <sup><em>(Platinum/HGSS)</em></sup></a></h1>
<blockquote>
<p>This tutorial was written by <a href="https://www.romhacking.net/community/6532/">RefinedPlat</a></p>
</blockquote>
<p>The goal of this tutorial is to use <code>AdrsValueSet</code> to alter a value related to the <code>DefogAnimation/FlashAnimation</code> command to make it update to an arbitrary weather of the scripter's choice.</p>
<p>First off, have a bit of context. Technically, the Generation 4 games have a command dubbed <code>ChangeWeather</code> that would alter the weather currently loaded by the area. Sadly, this command is dummied out, and will not work. However, the games do feature a pair of commands that set the weather to a specific value - <code>DefogAnimation</code><sup><em>Platinum</em></sup> and <code>FlashAnimation</code><sup><em>Heartgold</em></sup>. This, combined with a debug command called <code>AdrsValueSet</code> which allows for free editing of values in the RAM, means that these commands can be altered to change the weather to entirely different values, allowing for free control over the weather within a script with certain caveats.</p>
<blockquote>
<p>The following scripts change the weather <code>Defog</code><sup><em>Platinum</em></sup> or <code>Flash</code><sup><em>Heartgold</em></sup> set to your desired value. It then runs the <code>DefogAnimation</code>/<code>FlashAnimation</code> command to update the weather, and afterwards reverts the weather back to normal and finally sets it back to <code>0x0</code>/<code>0xC</code> so Defog/Flash work properly after the fact. This affects both in-battle and overworld weather. Obviously, if the default weather in an area is different, you'll have to make another <code>AdrsValueSet</code> to change it to that weather before setting the changed value back to default.
By doing a <code>TrainerBattle</code> command after triggering the shift, and then doing a <code>DefogAnimation</code> right afterwards, you can set weather for the duration of a battle and turn it off afterwards.</p>
<blockquote>
<p>Note that this does not show any unique animation or sound effect, and only updates the weather.</p>
</blockquote>
</blockquote>
<p>Keep in mind that the default value for Defog weather is 0x0 while Flash weather is 0xC.</p>
<hr />
<h2 id="important-limitations"><a class="header" href="#important-limitations">Important limitations:</a></h2>
<ul>
<li>You cannot run <code>FlashAnimation</code> or <code>DefogAnimation</code> in a Level Script while in a loading zone. This generates a null reference pointer and causes the game to crash on real hardware.
<ul>
<li>This basically means any screen transitions where you fade to black are off-limits, but ones where you simply move across the same matrix are okay. This includes very few areas in vanilla, however.</li>
</ul>
</li>
<li>Certain weather particles are on the same layer as the battle intro nametags. Consequently, having sandstorm weather when fighting Bertha will make her name move with the particles. This is how weather works in general and not specific to this tutorial.</li>
</ul>
<p>The <code>AdrsValueSet</code> value you want to change depends on the game and region. It uses absolute offsets within the RAM, so if you have changed the arm9's length you may need to find it again. Here is how to find the offsets of the values that this tutorial uses:</p>
<ul>
<li>
<p>Platinum:</p>
<ul>
<li><code>70 BD 38 B5 04 1C XX XX XX XX C0 68 F7 F7 XX XX XX XX 00 21 XX XX XX XX 28 1C F7 F7 BC FD 80 34 01 1C 20 68 40 68 C0 68 XX XX XX XX 01 20 38 BD</code></li>
</ul>
</li>
<li>
<p>Heart Gold: </p>
<ul>
<li><code>70 BD 38 B5 04 1C XX XX XX XX C0 68 F8 F7 XX XX XX XX 0C 21 XX XX XX XX 28 1C F8 F7 52 F9 80 34 01 1C 20 68 40 68 C0 68 XX XX XX XX 01 20 38 BD</code></li>
</ul>
</li>
</ul>
<p><br><br></p>
<p>For this tutorial there are a few offsets used: </p>
<ul>
<li>USA Platinum uses <code>0x2042BF8</code></li>
<li>USA Heartgold uses <code>0x20436D4</code></li>
</ul>
<details>
  <summary> Sample Script 1 - USA Platinum, Set Weather </summary>
<pre><code class="language-asm">Script 1:
	AdrsValueSet 0x2042BF8 0x##
	DefogAnimation
	AdrsValueSet 0x2042BF8 0x0
End
</code></pre>
</details>
<details>
  <summary> Sample Script 2 - USA Heartgold, Set Low Light </summary>
<pre><code class="language-asm">Script 1:
	AdrsValueSet 0x20436D4 0xD
	FlashAnimation
	AdrsValueSet 0x20436D4 0xC
End
</code></pre>
</details>
<details>
  <summary> Sample Script 3 - USA Heartgold, Temporary Weather</summary>
<pre><code class="language-asm">Script 2:
  AdrsValueSet 0x20436D4 0x##
	FlashAnimation
	AdrsValueSet 0x20436D4 0x0
	[Script Contents]
	FlashAnimation
	AdrsValueSet 0x20436D4 0xC
End
</code></pre>
</details>
<div style="break-before: page; page-break-before: always;"></div><h1 id="fairy-type-in-b2w2"><a class="header" href="#fairy-type-in-b2w2">Fairy Type in B2W2</a></h1>
<blockquote>
<p>This guide was written by <a href="https://github.com/BluRosie">BluRose</a> based significantly on research from <a href="https://www.pokecommunity.com/showthread.php?t=349000">MeroMero</a>.</p>
</blockquote>
<p>This is a tutorial that details how to insert the Fairy type in Black 2 and White 2 using MeroMero's <a href="https://www.pokecommunity.com/showthread.php?t=349000">initial research from years ago</a> and building upon it with a new and improved better understanding of just what happens in the assembly.  While yet imperfect, the improvements allow for a much better Fairy representation overall, eliminating the appearance of glitched graphics and crashes entirely.</p>
<hr />
<h2 id="table-of-contents-1"><a class="header" href="#table-of-contents-1">Table of Contents</a></h2>
<ul>
<li><a href="gen5/b2w2/guides/fairy/fairy.html#graphics">Graphics</a>
<ul>
<li><a href="gen5/b2w2/guides/fairy/fairy.html#type-icons---a082-a125">Type Icons - <code>a/0/8/2</code>, <code>a/1/2/5</code></a></li>
<li><a href="gen5/b2w2/guides/fairy/fairy.html#move-selection-palette---a011">Move Selection Palette - <code>a/0/1/1</code></a></li>
<li><a href="gen5/b2w2/guides/fairy/fairy.html#hall-of-fame-palette---a213">Hall of Fame Palette - <code>a/2/1/3</code></a></li>
</ul>
</li>
<li><a href="gen5/b2w2/guides/fairy/fairy.html#code---asm-file">Code - ASM File</a></li>
<li><a href="gen5/b2w2/guides/fairy/fairy.html#cleanup">Cleanup</a></li>
<li><a href="gen5/b2w2/guides/fairy/fairy.html#todo">TODO</a></li>
</ul>
<h2 id="graphics"><a class="header" href="#graphics">Graphics</a></h2>
<p>Various other type graphics are leftover from possible features.  We look to replace those here.</p>
<h3 id="type-icons---a082-a125"><a class="header" href="#type-icons---a082-a125">Type Icons - <code>a/0/8/2</code>, <code>a/1/2/5</code></a></h3>
<p>Here we replace the Cool and ??? type icons with the Fairy type icon to allow us to print the icon.  Tinke allows us to do this by replacing the relevant files, first in <code>a/0/8/2</code>: </p>
<p><a href="gen5/b2w2/guides/fairy/a082_33.RLCN">a082_33.RLCN</a> and <a href="gen5/b2w2/guides/fairy/a082_51.RGCN">a082_51.RGCN</a> should replace the ones in the ROM from an extracted <code>a/0/8/2</code>.</p>
<p>This replaces <img src="gen5/b2w2/guides/fairy/cool_type.png" alt="" /> with <img src="gen5/b2w2/guides/fairy/fairy_type_1.png" alt="" /></p>
<p>Similarly in <code>a/1/2/5</code>, we just replace the ??? type icon at the bottom of an image to now be the Fairy type, replacing the files in <code>a/1/2/5</code> with <a href="gen5/b2w2/guides/fairy/a125_22.RLCN">a125_22.RLCN</a> and <a href="gen5/b2w2/guides/fairy/a125_23.RGCN">a125_23.RGCN</a></p>
<p>This replaces <img src="gen5/b2w2/guides/fairy/question_type.png" alt="" /> with <img src="gen5/b2w2/guides/fairy/fairy_type_2.png" alt="" />.</p>
<h3 id="move-selection-palette---a011"><a class="header" href="#move-selection-palette---a011">Move Selection Palette - <code>a/0/1/1</code></a></h3>
<p>Here we add a new palette to <code>a/0/1/1</code> to make Fairy moves appear as pink in the move selection screen.</p>
<p>This file is <a href="gen5/b2w2/guides/fairy/a011_572.RLCN">a011_572.RLCN</a>.</p>
<p><code>a011</code> originally just has 571 files.  We add a 572nd file for our purposes.  You can either unpack/repack using narchive (included in the b2w2-fairy repository) or Extract directory using Tinke, add the file, and Change by directory using Tinke again.</p>
<h3 id="hall-of-fame-palette---a213"><a class="header" href="#hall-of-fame-palette---a213">Hall of Fame Palette - <code>a/2/1/3</code></a></h3>
<p>Here we add a new palette to <code>a/2/1/3</code> to make Fairy Pokémon show up in the Hall of Fame with a pink nameplate.  This is currently bugged and unfinished, but once the code is written it will be fixed in the Git repo.</p>
<p>The file to replace with once extracted:  <a href="gen5/b2w2/guides/fairy/a213_9.RLCN">a213_9.RLCN</a></p>
<h2 id="code---asm-file"><a class="header" href="#code---asm-file">Code - ASM File</a></h2>
<p>I have made a <a href="https://github.com/BluRosie/b2w2-fairy">repository</a> which should be downloaded as-is that has the fairy type code and is maintained as such.  Any additions or changes (future bugfixes!) will be included there.</p>
<p>All you <em>need</em> to do is follow the instructions there, abridged here (currently for Windows only):</p>
<ul>
<li>Place your White 2/Black 2 ROM in the base folder (<code>b2w2-fairy-main</code>) as <code>base.nds</code></li>
<li>Read and modify the configs at the beginning of <code>asm\fairy.s</code>.  The only one that should really be changed is <code>BLACK2</code> being <code>1</code> if you are applying to Black 2, and <code>0</code> if applying to White 2.</li>
<li>Double click on the <code>applyfairytype.bat</code> batch file
<ul>
<li>A script will run that applies all the Fairy type code changes to copied overlay files and recompresses them in the base folder for ROM insertion</li>
</ul>
</li>
<li>Open <code>base.nds</code> in Tinke</li>
<li>&quot;Change file&quot; all of overlays 167, 168, 207, 255, 265, the overlay table (y9.bin), and the arm9</li>
<li>Save your ROM as some other named file</li>
</ul>
<details>
<summary>Documentation - Code Changes</summary>
<br>
<p><b>Overlay 167</b></p>
<p>This overlay hosts the type chart.  All the edits made to this overlay are for adjusting the type chart.  The type chart declaration is</p>
<pre><code class="language-c">const u8 gTypeEffectiveness[NUM_OF_TYPES][NUM_OF_TYPES];

gTypeEffectiveness[atkType][defType] grabs the effectiveness of atkType when attacking defType
- 08 is super effective
- 04 is normal effective
- 02 is not very effective
- 00 is ineffective
</code></pre>
<p>So all of the code for accessing subsequent entries needs to take into account an extra element in each row and an extra column.</p>
<br>
<p><b>Overlay 168</b></p>
<p>This overlay hosts the move type -&gt; move selection palette table.  We just write a 572 near the end of the file and leave it be to correspond to the newly created nclr in a011.</p>
<br>
<p><b>Overlay 207</b></p>
<p>This overlay handles a lot of the code for the summary screen.  We edit it to support the new type icon.</p>
<p>The old structure allocated for this was <code>0x264</code> in size, and at <code>0x130</code> it kept track of the type icon OAM id's or something like that.  I'm honestly not 100% certain what it is, but it maps something to the graphics.  This is a common theme with all of the type icon edits made.</p>
<p>First, we double the memory heap allocation size for the summary screen to give us freedom in messing with the structure.  We need to add an entry to the <code>0x130</code> structure.  This is an issue--it's baked into the overall structure.  We need to move it to the end of the old structure--we can do this by replacing the <code>0x130</code> entries that represent this with <code>0x264</code> and to increase the size of the allocated structure to begin with to allow for this moving.  How this is done is documented in the <code>asm\fairy.s</code> file.</p>
<br>
<p><b>Overlay 255</b></p>
<p>Similarly, the PC Screen has a structure <code>0xA5BC</code> in size.  At <code>0xA268</code> of this structure, the type icon OAM id's are stored once again.  This would be as simple as moving it to the end, but <code>0xA268</code> is actually just a part of a substructure that is baked into the overall structure that starts at <code>0x18C</code>.  At <code>0xA0DC</code> of this substructure, there is a massive array of OAM id's for every sprite that is possibly on screen.  This includes and captures the <code>0xA268</code> from the overall structure--so I end up writing a hook into that area that checks for the overall structure offset and will redirect it to the end if it's part of the type icons.</p>
<p>Whenever switching off of a Pokémon, the type icons are all deleted and and replaced--this is done by deleting all of the type OAM id's in a for loop.  There are two separate code areas that are run for these, one for switching onto a new Pokémon and another for switching into blank space.  These for loops are both expanded to run one more time for the Fairy type.</p>
<p>This new type then takes the tag of one of the boxes when &quot;move Pokémon&quot; is selected, so the box is then deleted instead of loaded in properly.  Need to look into moving the boxes to be one tag later.</p>
<br>
<p><b>Overlay 265</b></p>
<p>Here, the table <code>u32 type_to_loaded_gfx_hof[NUM_OF_TYPES]</code> exists to map the types to their loaded SPA file when the hall of fame cutscene happens.  This SPA is all of the particles that appear when the Pokémon slides on screen.  Similarly, the palette table is at the very end of the overlay, but currently assigning a valid palette causes a crash in the hall of fame.  As such, we currently just load an invalid palette to prevent the crash.</p>
</details>
<p><img src="gen5/b2w2/guides/fairy/summary_1.png" alt="" /> <img src="gen5/b2w2/guides/fairy/summary_2.png" alt="" /> <img src="gen5/b2w2/guides/fairy/select.png" alt="" /> <img src="gen5/b2w2/guides/fairy/pc_screen.png" alt="" /></p>
<h2 id="cleanup"><a class="header" href="#cleanup">Cleanup</a></h2>
<p>From there, just make Struggle type 18 to make it typeless.  Assign all the Pokémon that need it to be Fairy type.  Make moves that have the Fairy typing as well.  It's now a functional type entirely!</p>
<h2 id="todo-1"><a class="header" href="#todo-1">TODO</a></h2>
<ul>
<li>Type icon in the Dex does not show up--pure fairy types don't have anything show up!  Does not crash, though.</li>
<li>Hall of Fame palette loading--memory overflow or something?  Having it load nothing works fine, but appears as a black void.</li>
<li>PC Screen tag overlap--fairy is loaded in the same sprite slot as one of the box icons and is both scrolled as such and the box icon doesn't show up in the menu.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="code-injection-guide-generation-v"><a class="header" href="#code-injection-guide-generation-v">Code Injection Guide (Generation V)</a></h1>
<p><em>It is recommended to check out the <a href="gen5/universal/guides/code_injection/universal/guides/code_injection/code_injection.html">universal code injection guide</a> before attempting this. This tutorial assumes that you have intermediate C++/ARMv5T assembly knowledge and know how to use a compiler or build system.</em></p>
<h2 id="setting-up-your-environment"><a class="header" href="#setting-up-your-environment">Setting up your environment</a></h2>
<p>So, you think you've got what it takes to have a crack at Generation V code injection? Then press onward!</p>
<p>First, we've got to set up a few prerequisites. It's a boring job but I promise it'll be smooth sailing from there on out. To start, download (and install, where applicable) all these:</p>
<ul>
<li><a href="https://github.com/kingdom-of-ds-hacking/CTRMap-CE/releases">CTRMap Community Edition</a></li>
<li><a href="https://github.com/kingdom-of-ds-hacking/CTRMapV">CTRMapV (Generation V plugin for CTRMap)</a></li>
<li><a href="https://developer.arm.com/downloads/-/arm-gnu-toolchain-downloads">The <code>arm-none-eabi</code> GCC toolchain</a></li>
<li><a href="https://github.com/kingdom-of-ds-hacking/PMC/releases">Latest RPM build of <code>PMC</code></a></li>
<li><a href="https://github.com/kingdom-of-ds-hacking/swan">Pokémon White 2 development headers</a></li>
<li><a href="https://github.com/HelloOO7/NitroKernel/releases">Latest NitroKernel DLL</a></li>
</ul>
<p><strong>Note: This guide assumes that you are using a American Pokémon White 2 [IRDO] (and strictly no other) ROM. This does not mean Black, White, or Black 2 cannot be used; as long as you provide the relevant materials, they can be used for code injection.</strong> </p>
<p>Before you get into code injection, set up a CTRMap project and load it up. If everything went as planned, there should be a <code>Code injection</code> section in your <code>Extras</code> tab. This is where it gets interesting:</p>
<ol>
<li>Click the <code>Install/Update PMC</code> button and select your <code>PMC.rpm</code> file. You should do this every time <code>libRPM</code> is updated, as the DLLs that CTRMap produces need the latest version of PMC to be recognized.</li>
<li>Make sure that there is a <code>patches</code> directory in your project's <code>vfs/data</code>. If there isn't one, create it. Move your <code>NitroKernel.dll</code> into that directory.</li>
<li>Export your ROM from CTRMap.</li>
<li>If everything went correctly, there should be a <code>00</code> byte at <code>0x02005050</code> in your game's RAM as part of PMC's initialization code.</li>
</ol>
<h2 id="building-code-injection-patches"><a class="header" href="#building-code-injection-patches">Building code injection patches</a></h2>
<h3 id="symbol-maps"><a class="header" href="#symbol-maps">Symbol maps</a></h3>
<p>There are two quintessential things that you need in order to begin writing proper code injection modules. The first one - a compiler - you've already got since Chapter 1. The other is what we call an <code>ESDB</code> (short for &quot;external symbol database&quot;) and is pretty much the stepping stone for interfacing and hijacking game routines. If you've already got one from a friend or relative, you should be all set, however, should you need to build your own one, that's also an option:</p>
<ol>
<li>Export the symbols you need from IDA using <code>File &gt; Produce file &gt; Create MAP file...</code></li>
<li>Copy the contents of IDA's Segment Register table (<code>View &gt; Open subviews &gt; Segment registers</code>) into a text file.</li>
<li>Open the result <code>.map</code> file in a text editor and fix the segment starting addresses to their proper values instead of <code>00000000</code>. IDA's just sometimes moody like that.</li>
<li>Run <code>MAP2ESDB</code>. If you do not have it, there are two ways to acquire it.
<ul>
<li>Clone and build the <a href="https://github.com/HelloOO7/RPMAuthoringTools">RPM authoring tools</a>, then execute MAP2ESDB in your console.</li>
<li>Use the CTRMap JAR (<code>java -cp &lt;path to CTRMap JAR&gt; rpm.cli.MAP2ESDB</code>) to launch MAP2ESDB.</li>
</ul>
</li>
<li>Proceed with the instructions provided by the command line interface. Use your .map as <code>--map</code> and your segment register plaintext as <code>--thmfile</code>.</li>
<li>Once done, you should have an <code>esdb.yml</code> or similar all built and ready for code injection.</li>
</ol>
<h3 id="programming"><a class="header" href="#programming">Programming</a></h3>
<p>Here's where you'll finally put those headers you downloaded earlier to good use! Any function that you've included in your ESDB, you can now use from your C++ code as long as it is properly declared. <strong>If you hate C++ for some reason, <del>that's tough</del> you can also use assembly; see <a href="gen5/universal/guides/code_injection/code_injection.html#using-assembly">here</a>.</strong> </p>
<p>Some of the structures and functions we've researched have been compiled into the <code>swan</code> repo for convenience, and as long as they are in your ESDB, you can use them to their full advantage. Here are a couple of things you should keep in mind:</p>
<ul>
<li>Functions that have C linkage should be treated as such. Declaring them inside namespaces, or even outside them as plain C++ functions, will most likely not link up with your ESDB.</li>
<li>Failure to link a function against the ESDB is not reported in any way, since it's indistinguishable from a regular extern function present in a DLL and linked at run-time. Always make sure you've got everything registered properly before you commit.</li>
<li>Unless you really know what you're doing and you've got all the proper ABI functions handled, you shouldn't use the C++ standard library, RTTI or exceptions (in fact, you may want to disable them with <code>-fno-rtti</code> and <code>-fno-exceptions</code> in GCC).</li>
<li>Some C++ ABI features (pure virtual functions) are supported and backed by <code>NitroKernel</code>, but need to be included explicitly in order to prevent GCC from complaining. Including <code>ExtLib.Include</code> and its <code>ABI/exl_CxxAbi.h</code> should do the trick.</li>
<li>Floating point operations, albeit <em>very</em> slow, are supported on the DS to an extent, but should be avoided. <code>__aeabi_#fcmp#</code> functions aren't fully present on the target, so comparisons may produce undefined behavior.</li>
<li>Memory allocation through <code>malloc</code> and <code>free</code> will fail. This is because <code>malloc</code> by default allocates in the <code>0x02000000 - 0x02004000</code> area (as configured by the game), and said area is filled at boot for some reserved memory heaps. Instead, use the ExtLib new and delete operators (from <code>Heap/exl_MemOperators.h</code>) that pass through <code>exl::heap::Allocator</code>s, or Game Freak's <code>GFL_HeapAllocate</code> and <code>GFL_HeapDelete</code> functions. What might also be handy to know is that an <code>exl::heap::OSAllocator</code> can be created on demand for any GFL Heap ID with <code>exl::heap::OSAllocator::OSAllocator(HeapID heapId)</code>.</li>
<li>The entirety of the <code>ExtLib.Heap</code> library is included within your NitroKernel, so it's recommended that you use it wherever possible.</li>
<li>DLLs from the <code>lib</code> folder in the ROM root can be loaded using utility functions from NitroKernel's <code>k::dll</code> namespace.</li>
</ul>
<p>Got all that? Don't worry, if you didn't, I'm fairly sure this text isn't going to go anywhere. But now, we finally get to the fun part - actually injecting stuff!</p>
<h3 id="preparing-our-code-for-injection"><a class="header" href="#preparing-our-code-for-injection">Preparing our Code for Injection</a></h3>
<p>Historically, there were many ways of injecting code into existing executables, but they all essentially get down to one thing: hooks, or branches. Branches are, simply put, a processor directive that changes the program counter - a register containing a pointer to the currently executed instruction - to another value. Each ISA and CPU architecture has its own way of performing these, but in most cases only two things are required: a source and destination address. </p>
<p>In the early days of computing where programs had a fixed load address and memory space (also known as static loading), all branches were fully deterministic at compile time. This approach is still actually supported on modern CPUs through virtual memory addressing (in fact, some ancient Microsoft Windows programs rely on it to this day) and even though it's a thing of the past in desktop programming, it is still widely used in low-power embedded software, as is the case with standard Nintendo DS development. </p>
<p>However, since code injection is a highly volatile process with very little headroom, we've decided to borrow the more flexible approach of dynamic loading, which includes a lot of fun quirks that you can use to your own advantage. As per the definition of branches, any program jump requires a source and destination address, but since those may not be fully known at compile-time, they are often stored into a <a href="https://en.wikipedia.org/wiki/Relocation_(computing)">relocation table</a> that is used to correct the branch instructions within the program once the executable is fixed in memory. </p>
<p>Inasmuch as the DS has next to no memory protection, we can easily use these to perform the relocation process even outside of our program - such as the game code! All you've gotta do is adjust the relocation table accordingly, for which there are a grand total of two options:</p>
<ol>
<li>Use RPMTool's (<code>java -cp CTRMap.jar rpm.cli.RPMTool</code> or build RPMAuthoringTools) <code>--in-relocations-yml</code> to manually specify the relocations using an YML file (not recommended).</li>
<li>Use the automated hook derivation process built into CTRMap.</li>
</ol>
<p>To have the RPM converter automatically convert your function into a relocation referring to it, it needs to be in either of the following formats:</p>
<ul>
<li><code>&lt;RELOCATION_TYPE&gt;_FunctionName</code> - hooks directly into the start of a named function (e.g. <code>THUMB_BRANCH_BagSave_AddItem</code>)</li>
<li><code>&lt;RELOCATION_TYPE&gt;_FunctionName_0xoffset</code> - hooks into a function-relative offset (e.g. <code>THUMB_BRANCH_LINK_BagSave_AddItem_0x2</code>)</li>
<li><code>&lt;RELOCATION_TYPE&gt;_SEGMENT_0xaddress</code> - hooks at an absolute address within a segment (e.g. <code>FULL_COPY_ARM9_0x02008268</code>)</li>
</ul>
<p>I know that might be a lot to take in at first, so let's take this apart piece by piece. </p>
<ul>
<li>First of all, there's the function names. If a function is to be overriden with another, these should match the names in the ESDB, meaning they require explicit C linkage if used in C++. The relocation will then take place at the address of the function as specified in the ESDB, optionally offset by a constant addend. </li>
<li>Additionally, if you don't feel like using the name database or are aiming for some memory wizardry, you can directly input the memory address of the relocation. However, as a side effect of the static loading method used on the Nintendo DS, you also have to specify a &quot;segment&quot; (in a similar way as the ESDB segment header does) of the address, which ensures that the relocation won't be inadvertently applied to an undesirable module, such as an overlay that shares the memory area with another. </li>
<li>Last, but certainly not least, there is the <code>RELOCATION_TYPE</code> parameter. Its value specifies what data or CPU instruction should be written to the destination address. This is especially important on the ARM architecture, as it distinguishes between two instruction sets (ARM and Thumb) which use two separate methods of encoding. As a result, you've got quite a lot of options, but be wary - they are not at all interchangeable! The specific procedures are described in detail <a href="https://github.com/HelloOO7/libRPM/blob/master/include/RPM_Control.h">here</a>, but for starters, here's a quick reference that should hopefully guide you towards a correct choice:
<ul>
<li><code>THUMB_BRANCH</code> writes a one-way branch using the 16-bit Thumb instruction encoding. In most cases, this will be converted into a <code>PUSH, BL, PUSH</code> because of Thumb short branch restrictions, meaning you'll have to use another method for functions that use the stack for parameters (basically any with more than 4*4 bytes of arguments).</li>
<li><code>THUMB_BRANCH_SAFESTACK</code> does exactly that. While it takes up more space (which generally isn't a problem as the overriden function isn't going to be a little one just based off its argument count), this relocation type preserves all stack parameters.</li>
<li><code>THUMB_BRANCH_LINK</code> writes a simple BL/BLX using the 16-bit Thumb instruction encoding. This is useful for intercepting a function call in only one place as opposed to replacing the entire implementation.</li>
<li><code>ARM_BRANCH</code> and <code>ARM_BRANCH_LINK</code> - 32-bit ARM instructions equivalent to <code>THUMB_BRANCH</code> and <code>THUMB_BRANCH_LINK</code> respectively. Since ARM short branches cover a decent address range, there isn't a need for <code>THUMB_BRANCH_SAFESTACK</code>.</li>
<li><code>FULL_COPY</code> copies the raw contents of the function/symbol onto the destination address. Bear in mind that this will not carry over relocations (unless hard-linked into the ROM, which isn't our objective here) inside the function, so it is only useful for simple injections.</li>
</ul>
</li>
</ul>
<p>From here on, if you name your function according to these rules, the linker will magically make it so that it will override the specified code. The future is now, thanks to science!</p>
<h3 id="compiling"><a class="header" href="#compiling">Compiling</a></h3>
<p>You can compile your code using standard GCC CLI, or using a build system like CMake. While compiling, be sure to use the following options:</p>
<ul>
<li><code>-r</code> - produce a relocatable executable.</li>
<li><code>-march=armv5t</code> - target the ARMv5T architecture.</li>
<li><code>-mthumb (optional)</code> - generate Thumb instructions (instead of ARM).</li>
<li><code>-Os</code> - optimize for code size.</li>
</ul>
<p>Additionally, if using CMake, you'll need to provide the following variables before compiler configuration to pass the compiler test:</p>
<pre><code>set(CMAKE_SYSTEM_NAME             Generic)
set(CMAKE_SYSTEM_PROCESSOR            arm)
set(CMAKE_C_FLAGS   &quot;--specs=nosys.specs&quot;)
set(CMAKE_CXX_FLAGS &quot;--specs=nosys.specs&quot;)
</code></pre>
<p>If you're using dynamic linking for parts of your code, be sure to load the dependencies (and properly release them!) using <code>k::dll::LoadLibrary</code> (resp. <code>k::dll::ReleaseLibrary</code>) from NitroKernel. If you need to do this in initialization, create a <code>DllMain</code> function using libRPM's <code>RPM_DLLMAIN_DECLARE</code> and <code>RPM_DLLMAIN_DEFINE</code> macros, then write your loading code to run on module load/unload.</p>
<h3 id="linking"><a class="header" href="#linking">Linking</a></h3>
<p>Linking is probably the simplest part of the entire process, in fact, it's so trivial that we'll skip over it in just one (1) step:</p>
<ol>
<li>Click the <code>Convert ELF to DLL</code> button in CTRMap's Extras panel and follow the instructions.</li>
</ol>
<p>Just in case you didn't hear me, that's:</p>
<ol>
<li>When prompted, select the ESDB file to be used for linking (be wary that this will not be reloaded when changed on disk).</li>
<li>Then select the ELF file you compiled and a destination DLL file.</li>
<li>Copy the result DLL into your <code>patches</code> or <code>lib</code> folder.</li>
<li>You're done! Save your ROM, cross your fingers and start it up!</li>
</ol>
<h2 id="additional-notes"><a class="header" href="#additional-notes">Additional notes</a></h2>
<h3 id="using-assembly"><a class="header" href="#using-assembly">Using Assembly</a></h3>
<p>If you do not feel like writing C or C++, or you want to do a relatively simple patch, then you are also able to use assembly! 
C and C++ compile into assembly, which is then assembled into an executable and linkable format (ELF) file. Assembly is just assembled into the ELF format directly. So, you can very easily use tools such as kingcom's armips, or (if you set up the C/C++ compiler above) the GNU assembler.</p>
<p>To use assembly, just follow the same conventions above for naming functions/symbols. Then, assemble and link your file with the instructions above. Assuming you are using the GNU assembler, you just need to use the following options when assembling your file:</p>
<ul>
<li><code>-march=armv5t</code> - target the ARMv5T architecture.</li>
<li><code>-mthumb (optional)</code> - generate Thumb instructions (instead of ARM).</li>
<li><code>-mtune=arm946e-s</code> (optional) - target the ARM946E-S architecture.</li>
</ul>
<p>From there, just follow the steps for <a href="gen5/universal/guides/code_injection/code_injection.html#linking">linking</a>.</p>
<h3 id="patch-priority"><a class="header" href="#patch-priority">Patch priority</a></h3>
<p>Should you need to change the priority of loading a DLL patch to higher than 4 (default), hold the <code>Alt</code> key while clicking <code>Convert ELF to DLL</code> and you'll be prompted to choose the priority after conversion.</p>
<h3 id="changing-esdbs-mid-stream"><a class="header" href="#changing-esdbs-mid-stream">Changing ESDBs mid-stream</a></h3>
<p>Holding <code>Shift</code> while clicking <code>Convert ELF to DLL</code> will prompt you to re-select an ESDB even if you've selected one already.</p>
<h3 id="dynamic-loading"><a class="header" href="#dynamic-loading">Dynamic loading</a></h3>
<p>Unlike WinAPI where you need to use <code>GetProcAddress</code> unless you know the exact address layout of your DLL, libRPM's dynamic linker only requires function names to match (the lookup is done using fast hash tables, so technically there are only about 4 billion possible combos, meaning collision is possible). As a result, headers are all that's needed to properly include a library.</p>
<p>NitroKernel's library loader forces all libraries to be stored in <code>/lib</code> with the <code>.dll</code> extension. A library named <code>Library.dll</code> would then be loaded with <code>k::dll::LoadLibrary(&quot;Library&quot;)</code>.</p>
<h3 id="debug-prints"><a class="header" href="#debug-prints">Debug prints</a></h3>
<p>If you're using DeSmuMe or a similar &quot;nocash message&quot; compliant emulator, you can use the <code>_DeSmuMe</code> DLL of NitroKernel to enable debug prints through <code>k::Print</code> or <code>k::Printf</code>.</p>
<p>The maximum length of a print string in NitroKernel is 1024 characters.</p>
<h3 id="multithreading"><a class="header" href="#multithreading">Multithreading</a></h3>
<p>Should you really need to simulate a multi-threaded context on the Nintendo DS's single-core CPU (such as for audio processing or asynchronous rendering), you can do so using NitroKernel's <code>kThread</code> library. Keep in mind though that this will add a slight overhead to your code and should wherever possible be substituted with a single-threaded replacement.</p>
<h3 id="rpm-version-support"><a class="header" href="#rpm-version-support">RPM version support</a></h3>
<p>RPMs that do not target the libRPM version present in the installed PMC module will produce undefined behavior. It is therefore recommended to recompile all modules to the latest version in case of uncertainty. If you're using CTRMap, you can upgrade all modules in the <code>patches</code> and <code>lib</code> VFS folders using a button in the Extras panel.</p>
<h3 id="troubleshooting"><a class="header" href="#troubleshooting">Troubleshooting</a></h3>
<p>DeSmuME + IDA debugger is your best friend.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="general-code-injection-guide"><a class="header" href="#general-code-injection-guide">General Code Injection Guide</a></h1>
<p>This guide aims to serve as a technical introduction to code injection in the DS Pokemon games, as well as common processes for it. It is strongly recommended that you read this page before continuing onto generation-specific code injection, as it will attempt to familiarize you with how it generally works.</p>
<h2 id="assembly-injection"><a class="header" href="#assembly-injection">Assembly Injection</a></h2>
<p>Assembly injection is the process of compiling an assembly routine, and hooking it into the executable part of a ROM. </p>
<h2 id="cc-injection"><a class="header" href="#cc-injection">C/C++ Injection</a></h2>
<p>C/C++ injection is almost the exact same idea, except you use a high-level language (mostly C or C++, though you can go wild with Rust if that's what your heart desires) to create the code which emits assembly. That's because compilers/translators of these languages use Assembly as an intermediate between the source code stage and the binary stage. In other words, C/C++ code creates assembly code, which is then assembled. Assembly knowledge is, for the most part, not necessary.</p>
<h3 id="how-does-c-injection-work"><a class="header" href="#how-does-c-injection-work">How does C Injection work?</a></h3>
<p>It's easier to explain with an example, so I will go with that.</p>
<p>Say we have the following C code:</p>
<pre><code class="language-C">// We declare these so the code can compile. Can go into a separate library file.
int AddMoney(int);
void LoadScript(int);
void PlayScript();

// The function we're writing.
void funFunction1() {
  int v1 = AddMoney(3000);
  if (v1) {
    LoadScript(12);
    PlayScript();
  }
  for (int i = 0; i &lt; 99; ++i) {
    int v2 = AddMoney(i);
  }
  //...
}
</code></pre>
<p>Our compiler will take our C code and turn it into Assembly. How, you might be asking yourself? I will give you a high level idea of what is going on.</p>
<p>See, when we do an operation in C, the operation we do has a corresponding set of Assembly. By parsing the C file, the compiler can match each operation in our C source code to a list of Assembly instructions that are functionally equivalent. This yields an intermediate Assembly file, which pertains to the architecture of the system we are compiling the binary for. In this case, it would yield ARMv5T Assembly (unless otherwise specified), which is the Assembly variant used on the Nintendo DS.</p>
<p>In the case of our file, it would turn it into the following assembly (courtesy of <code>gcc</code>):</p>
<pre><code class="language-ASM">funFunction1:
        push    {r7, lr}
        sub     sp, sp, #16
        add     r7, sp, #0
        movw    r0, #3000
        bl      AddMoney
        str     r0, [r7, #8]
        ldr     r3, [r7, #8]
        cmp     r3, #0
        beq     .L2
        movs    r0, #12
        bl      LoadScript
        bl      PlayScript
.L2:
        movs    r3, #0
        str     r3, [r7, #12]
        b       .L3
.L4:
        ldr     r0, [r7, #12]
        bl      AddMoney
        str     r0, [r7, #4]
        ldr     r3, [r7, #12]
        adds    r3, r3, #1
        str     r3, [r7, #12]
.L3:
        ldr     r3, [r7, #12]
        cmp     r3, #98
        ble     .L4
        nop
        nop
        adds    r7, r7, #16
        mov     sp, r7
        pop     {r7, pc}
</code></pre>
<p>This code is functionally equivalent to the code we wrote, but might be harder to understand at first glance.</p>
<h2 id="insertion-process"><a class="header" href="#insertion-process">Insertion Process</a></h2>
<h3 id="fixing-our-assembly"><a class="header" href="#fixing-our-assembly">Fixing our Assembly</a></h3>
<p>Similar to the above, assembling Assembly consists of taking our code and translating it into a format that our processor can understand. The Executable and Linkable Format, or ELF, allows us to simplify this process. </p>
<p>Simply put, our processor does not read assembly -- only machine code -- and as such, we need to give it a set of bytes that it <em>can</em> read. But, before we can give it bytes to read, we need to make sure <em>all</em> of our instructions are correct. With simple arithmetic instructions such as addition and subtraction, this is light-work -- no further verification needs to be done. However, with function calls, <em>how</em> will the assembly know where we are telling it to go? </p>
<p>This is easily solved by converting our assembly into an ELF file. With an ELF, we can perform a process known as linking. Linking is one of the most important parts of the entire compilation process, and for good reason; with our Assembly in ELF format, we can define the addresses of functions we are calling, determine the order of multiple files being linked together, and create relocatable objects, all of which solve our earlier problems. So, let's go into detail about linking.</p>
<h4 id="assembly-to-executable-and-linkable-format-elf-and-linking"><a class="header" href="#assembly-to-executable-and-linkable-format-elf-and-linking">Assembly to Executable and Linkable Format (ELF), and Linking</a></h4>
<p>On the high level, linking is performed using a linker. A linker is equipped with a translation table which takes in symbol names, and translates them to addresses. This translation table is comprised of all of the addresses of functions in the binaries we link together, and a (optionally) hand-crafted symbol to address map.</p>
<p>This hand-crafted translation table is an integral part of code injection. Without it, calling existing functions would be practically impossible. This translation table is created by researching the ROM's code, and documenting the functions. We then give names to these functions, which we later use as symbols. This creates a one-to-one mapping that allows us to properly fix our addresses.</p>
<p>Take this segment of our Assembly from above, for example.</p>
<pre><code class="language-ARMASM">        movw    r0, #3000
        bl      AddMoney
</code></pre>
<p><code>bl</code>, which performs a function call in this case, will force the program to jump to the function <code>AddMoney</code>. But, <em>where</em> is <code>AddMoney</code>? We as humans know that it is at the address <code>30</code>, as I had mentioned previously. But, what about the computer? </p>
<p>With a translation table similar to below (note: this is likely not valid syntax, I am just making this up):</p>
<pre><code>BEGIN_TRANSLATION_DEFINITIONS
AddMoney: 30
LoadScript: 45
PlayScript: 60
END_TRANSLATION_DEFINITIONS
</code></pre>
<p>The aforementioned code becomes the following:</p>
<pre><code class="language-ARMASM">        movw    r0, #3000
        bl      30 @ Note, this will likely be a relative offset (destination - address of this instruction) and not an absolute one. This is just for demonstration.
</code></pre>
<p>Pretty neat, huh? The same thing would happen to <code>bl LoadScript</code> or <code>bl PlayScript</code>, provided those were the instructions there.</p>
<p>That being said, how do we perform linking with code injection?</p>
<ul>
<li>In the case of Generation IV, BluRose uses the linker provided by devkitPro (which is <code>arm-none-eabi-ld</code>) and a hand crafted translation table to fix the addresses to in-game functions. They also use a linker script to rearrange the order of their binary, which is a possibility I mentioned previously.</li>
<li>In the case of Generation V, the input source code is first linked using the default toolchain, then later post-processed using a provided symbol mapping database during conversion to the RPM executable format. This means that before the final step, the ELF isn't bound to a fixed binary layout, providing simpler targeting of different games/revisions. Programs that only provide support functionality (file format libraries, codecs) are game-independent and can be loaded on-demand as DLLs.</li>
</ul>
<p>After linking, we will usually end up with an ELF file that we can use to create our final binary.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="intro-to-sprite-indexing"><a class="header" href="#intro-to-sprite-indexing">Intro to Sprite Indexing</a></h1>
<blockquote>
<p>This document was written by turtleisaac</p>
</blockquote>
<p>This document aims to introduce the concept of indexing a sprite</p>
<hr />
<h2 id="indexing"><a class="header" href="#indexing">Indexing</a></h2>
<p>Indexing is a process that converts an image from having a specific color assigned to each individual pixel to having a centralized palette where the RGB(A) values are stored.</p>
<p>By doing this, each pixel is assigned a specific index within the palette instead of an individual color. This allows image files to take up less space.</p>
<p><img src="universal/guides/sprite_indexing/indexed_image_example.png" alt="Indexed Image Example" /></p>
<h2 id="special-considerations-for-the-nintendo-ds"><a class="header" href="#special-considerations-for-the-nintendo-ds">Special Considerations for the Nintendo DS</a></h2>
<ul>
<li>The Pokémon DS games (and most others) use NCGR files for storing images, and NCLR files for storing palettes. The NCLR file that a NCGR pulls its palette information from is determined by the code of the game, so when viewing or replacing NCGR files in a tool like Tinke, you must first select the proper NCLR for that image for the correct palette to be displayed</li>
<li>Sprites within these games lack an alpha channel
<ul>
<li>If the game is programmed to display the image with any form of transparency, it will use the color at index 0 of the palette to determine what part of the sprite should be made transparent when displaying it</li>
</ul>
</li>
<li>Most sprites are 8bpp (8 bits per pixel), meaning they have a maximum palette size of 256 colors</li>
</ul>
<hr />
<h2 id="guides-for-specific-tools"><a class="header" href="#guides-for-specific-tools">Guides for Specific Tools</a></h2>
<ul>
<li><a href="universal/guides/sprite_indexing/gimp/gimp.html">GIMP</a></li>
</ul>
<blockquote>
<p>TODO: Aseprite, Photoshop, GraphicsGale, Paint.NET</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="sprite-indexing-with-gimp-guide"><a class="header" href="#sprite-indexing-with-gimp-guide">Sprite Indexing with GIMP Guide</a></h1>
<blockquote>
<p>This guide was written by <a href="https://github.com/turtleisaac">turtleisaac</a>.</p>
</blockquote>
<p>This guide aims to serve as general instructions for indexing a sprite using GIMP, a free and open-source image editing program which is available on GNU/Linux, macOS, Windows, and more</p>
<hr />
<h2 id="table-of-contents-2"><a class="header" href="#table-of-contents-2">Table of Contents</a></h2>
<ul>
<li><a href="universal/guides/sprite_indexing/gimp/gimp.html#Instructions">Instructions</a>
<ul>
<li><a href="universal/guides/sprite_indexing/gimp/gimp.html#Indexing">Indexing</a></li>
<li><a href="universal/guides/sprite_indexing/gimp/gimp.html#Palette-Editing">Palette Editing</a>
<ul>
<li><a href="universal/guides/sprite_indexing/gimp/gimp.html#Putting-the-Background-Color-in-Index-0">Putting the Background Color in Index 0</a></li>
</ul>
</li>
<li><a href="universal/guides/sprite_indexing/gimp/gimp.html#Saving">Saving</a></li>
</ul>
</li>
</ul>
<h2 id="instructions"><a class="header" href="#instructions">Instructions</a></h2>
<ol>
<li><strong>To begin, if you don't have it already, you'll want to download <a href="https://www.gimp.org/downloads/">GIMP</a>.</strong></li>
<li>From here, open an image of your choice in GIMP. If this image has an alpha channel, it technically can be removed, but that image most likely wouldn't be ideal for inserting in the first place and really shouldn't be used.</li>
<li>Depending on the constraints of what kind of image you are replacing, the number of colors available for your indexed image may vary. In most cases, you are either limited to 256 colors or 16 colors. This guide will assume you are indexing an image that can only have 16 colors, but the same process will work for a 256 color image.</li>
</ol>
<p><strong>NOTE:</strong> if your image is already indexed adequately, such as if you are editing an existing image exported from the ROM and you just want to change the colors, you may skip ahead to <a href="universal/guides/sprite_indexing/gimp/gimp.html#Palette-Editing">Palette Editing</a>.</p>
<h3 id="indexing-1"><a class="header" href="#indexing-1">Indexing</a></h3>
<ol start="4">
<li>
<p>In the toolbar, you'll want to go to <code>Image -&gt; Mode -&gt; Indexed...</code></p>
</li>
<li>
<p>If <code>Generate optimum palette</code> isn't already selected, do so. After that, set the maximum number of colors to 16. Press <code>Convert</code> in the bottom right of the window.</p>
<p><img src="universal/guides/sprite_indexing/gimp/gimp_img_1.png" alt="img1" /></p>
</li>
</ol>
<h3 id="palette-editing"><a class="header" href="#palette-editing">Palette Editing</a></h3>
<ol start="6">
<li>
<p>To make it so you can edit the palette order and/or see/edit the colors in the palette, go to <code>Windows -&gt; Dockable Dialogues -&gt; Colormap</code>.</p>
<p><img src="universal/guides/sprite_indexing/gimp/gimp_img_2.png" alt="img2" /></p>
<p>Doing so will bring up the following tab:</p>
<p><img src="universal/guides/sprite_indexing/gimp/gimp_img_3.png" alt="img3" /></p>
</li>
<li>
<p>From here, you can double-click on the colors in the palette to edit them. Located at the bottom of the Colormap tab is this bar:</p>
<p><img src="universal/guides/sprite_indexing/gimp/gimp_img_4.png" alt="img4" /></p>
<p>You can also press the button that has a pencil and some lines in order to edit the currently selected color. The plus-sign button can be used to add a new color to the palette. If the background color is already in index 0 of the palette, you may skip ahead to <a href="universal/guides/sprite_indexing/gimp/gimp.html#Saving">Saving</a>.</p>
</li>
</ol>
<h4 id="putting-the-background-color-in-index-0"><a class="header" href="#putting-the-background-color-in-index-0">Putting the Background Color in Index 0</a></h4>
<ol start="8">
<li>
<p>You can right-click on a color to get this menu, then from there, you press <code>Rearrange Colormap...</code>. Click and drag the color you want to move to index 0 of the palette.</p>
<p><img src="universal/guides/sprite_indexing/gimp/gimp_img_5.png" alt="img5" />
<img src="universal/guides/sprite_indexing/gimp/gimp_img_6.png" alt="img6" /></p>
<p>When you go to let go of the dragged color, <strong>MAKE SURE</strong> there is a white box surrounding the color at index 0, as shown in the first image below. It <strong>SHOULD NOT</strong> look like the second image below, with a white line to either side, on-top of, or below the color. From here, just press <code>Ok</code>.</p>
<p><img src="universal/guides/sprite_indexing/gimp/gimp_img_7.png" alt="img7" />
<img src="universal/guides/sprite_indexing/gimp/gimp_img_8.png" alt="img8" /></p>
</li>
</ol>
<h3 id="saving"><a class="header" href="#saving">Saving</a></h3>
<ol start="10">
<li>
<p>Go to <code>File -&gt; Export As...</code></p>
<p><img src="universal/guides/sprite_indexing/gimp/gimp_img_9.png" alt="img1" /></p>
</li>
<li>
<p>Choose where you want to output the file, and make sure you use the <code>.png</code> extension.</p>
</li>
<li>
<p>Make sure you select <code>8bpc RGB</code> for the output format.</p>
<p><img src="universal/guides/sprite_indexing/gimp/gimp_img_10.png" alt="img10" /></p>
</li>
<li>
<p>Now, you can insert the exported image into the game files, as per the instructions of any other guide you may be following or tool you may be using.</p>
</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="town-map-spots"><a class="header" href="#town-map-spots">Town Map Spots</a></h1>
<p>These structures are used to describe the Town Map selectable structures in Heart Gold and Soul Silver as they appear baked into Overlay 101.</p>
<hr />
<h3 id="gearmaptownoverlay-struct-description"><a class="header" href="#gearmaptownoverlay-struct-description">GearMapTownOverlay Struct Description</a></h3>
<pre><code class="language-c">struct GearMapTownOverlay
{
    /* 0x0 */ u16 mapHeader;
    /* 0x2 */ u16 gateAppearance; // not sure
    /* 0x4 */ u8 entry; // maybe
    /* 0x5 */ u8 entry2; // maybe
    /* 0x6 */ u8 redX;
    /* 0x7 */ u8 redY;
    /* 0x8 */ u8 grayX;
    /* 0x9 */ u8 grayY;
    /* 0xA */ u8 townDimY:4; // msn
              u8 townDimX:4; // lsn
    /* 0xB */ u8 replacementDimY:4; // msn
              u8 replacementDimX:4; // lsn
    /* 0xC */ u8 offsetY:4; // msn
              u8 offsetX:4; // lsn
    /* 0xD */ u8 padding;
}; // entry size = 0xE
</code></pre>
<div class="table-wrapper"><table><thead><tr><th>Field Name</th><th>Description</th><th>Data Type</th></tr></thead><tbody>
<tr><td>mapHeader</td><td>the map header that the entry describes</td><td>u16</td></tr>
<tr><td>gateAppearance</td><td>the map header that describes gates for the entry</td><td>u16</td></tr>
<tr><td>entry</td><td>the entry in this table (maybe?)</td><td>u8</td></tr>
<tr><td>entry2</td><td>the entry in recorded visit (has player visited entry?)</td><td>u8</td></tr>
<tr><td>redX</td><td>the base x coordinate for the red blocks (shifted right one)</td><td>u8</td></tr>
<tr><td>redY</td><td>the base y coordinate for the red blocks (shifted up one)</td><td>u8</td></tr>
<tr><td>grayX</td><td>the base x coordinate for the gray block on the image</td><td>u8</td></tr>
<tr><td>grayY</td><td>the base y coordinate for the gray block on the image</td><td>u8</td></tr>
<tr><td>townDimY</td><td>the amount of matrix chunks the town spans up and down</td><td>u8:4 (4 bits)</td></tr>
<tr><td>townDimX</td><td>the amount of matrix chunks the town spans left and right</td><td>u8:4 (4 bits)</td></tr>
<tr><td>offsetY</td><td>y offset within the replacement block of the actual town</td><td>u8:4 (4 bits)</td></tr>
<tr><td>offsetX</td><td>x offset within the replacement block of the actual town</td><td>u8:4 (4 bits)</td></tr>
<tr><td>padding</td><td>unused (ensures next entry is 2-byte aligned)</td><td>u8</td></tr>
</tbody></table>
</div>
<h3 id="gearmaptownselectionoverlay-struct-description"><a class="header" href="#gearmaptownselectionoverlay-struct-description">GearMapTownSelectionOverlay Struct Description</a></h3>
<pre><code class="language-c">struct GearMapTownSelectionOverlay
{
    /* 0x0 */ u16 mapHeader;
    /* 0x2 */ u8 baseX; // in poke gear position
    /* 0x3 */ u8 baseY; // in poke gear position
    /* 0x4 */ u8 dimY:4; // msn
              u8 dimX:4; // lsn
    /* 0x5 */ u8 flags;
    /* 0x6 */ u8 textEntry; // in a027 file 273
    /* 0x7 */ u8 flySpot;
    /* 0x8 */ u32 padding;
    /* 0xC */ u8 orangeBaseX; // in image
    /* 0xD */ u8 orangeBaseY; // in image
    /* 0xE */ u8 orangeDimX; // in image
    /* 0xF */ u8 orangeDimY; // in image
}; // size = 0x10
</code></pre>
<div class="table-wrapper"><table><thead><tr><th>Field Name</th><th>Description</th><th>Data Type</th></tr></thead><tbody>
<tr><td>mapHeader</td><td>the map header that the entry describes</td><td>u16</td></tr>
<tr><td>baseX</td><td>base x position in PokéGear</td><td>u8</td></tr>
<tr><td>baseY</td><td>base y position in PokéGear</td><td>u8</td></tr>
<tr><td>dimY</td><td>y dimension of selection overlay in tiles</td><td>u8:4 (4 bits)</td></tr>
<tr><td>dimX</td><td>x dimension of selection overlay in tiles</td><td>u8:4 (4 bits)</td></tr>
<tr><td>flags</td><td>flags that seemingly control when/how things are shown</td><td>u8</td></tr>
<tr><td>textEntry</td><td>text entry to use from a027 file 273 for the blurb</td><td>u8</td></tr>
<tr><td>flySpot</td><td>towns with a fly spot have this nonzero</td><td>u8</td></tr>
<tr><td>padding</td><td>unused field</td><td>u32</td></tr>
<tr><td>orangeBaseX</td><td>base x position in image of the orange overlay block</td><td>u8</td></tr>
<tr><td>orangeBaseY</td><td>base y position in image of the orange overlay block</td><td>u8</td></tr>
<tr><td>orangeDimX</td><td>x dimension in image of the orange overlay block</td><td>u8</td></tr>
<tr><td>orangeDimY</td><td>y dimension in image of the orange overlay block</td><td>u8</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="zone-entities-container"><a class="header" href="#zone-entities-container">Zone Entities Container</a></h1>
<p>The NARC containing these files can be found in the following game paths:</p>
<ul>
<li>Black and White: /a/1/2/5</li>
<li>Black 2 and White 2: /a/1/2/6</li>
</ul>
<hr />
<h1 id="container-structure"><a class="header" href="#container-structure">Container Structure</a></h1>
<pre><code class="language-C">struct ZoneEntitiesContainer {
    uint32_t pInitializationScripts; // Relative pointer to initialization scripts.
    uint8_t InteractablesCount;
    uint8_t NPCCount;
    uint8_t WarpCount;
    uint8_t TriggerCount;

    InteractableEntry Interactables[InteractablesCount];
    NPCEntry NPCs[NPCCount];
    WarpEntry Warp[WarpCount];
    TriggerEntry Trigger[TriggerCount];


    DynamicInitializationEntry pDynamicInitScripts;
    StaticInitializationEntry StaticInitScripts; 
} 
</code></pre>
<hr />
<h1 id="section-structures"><a class="header" href="#section-structures">Section Structures</a></h1>
<h2 id="interactable-entry"><a class="header" href="#interactable-entry">Interactable Entry</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Field Name</th><th>Description</th><th>Data Type</th></tr></thead><tbody>
<tr><td>Script ID</td><td>The script to execute when interacted with. Read from the zone's script container.</td><td>uint16_t</td></tr>
<tr><td>Condition</td><td>The condition needed for this interactable to allow interactions.</td><td>uint16_t</td></tr>
<tr><td>Interactibility</td><td>The sides which the interactable can be interacted with.</td><td>uint16_t</td></tr>
<tr><td>RailSystem Index</td><td>The index of the interactable in the context of RailSystem, the 3D permissions system.</td><td>uint16_t</td></tr>
<tr><td>X</td><td>The world X position of the interactable.</td><td>uint32_t</td></tr>
<tr><td>Z</td><td>The world Z position of the interactable.</td><td>uint32_t</td></tr>
<tr><td>Y</td><td>The world Y position of the interactable.</td><td>int32_t</td></tr>
</tbody></table>
</div>
<h2 id="npc-entry"><a class="header" href="#npc-entry">NPC Entry</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Field Name</th><th>Description</th><th>Data Type</th></tr></thead><tbody>
<tr><td>ID</td><td>The ID that will be used to reference the NPC in game.</td><td>uint16_t</td></tr>
<tr><td>Model ID</td><td>The ID of the sprite to use for the NPC in game.</td><td>uint16_t</td></tr>
<tr><td>Movement Code</td><td>The default movement behavior of the NPC in game.</td><td>uint16_t</td></tr>
<tr><td>Type</td><td>The type of NPC to be spawned.</td><td>uint16_t</td></tr>
<tr><td>Spawn Flag</td><td>The flag which can be used to control the NPC's presence in game.</td><td>uint16_t</td></tr>
<tr><td>Script ID</td><td>The script which the NPC will use when interacted with in game.</td><td>uint16_t</td></tr>
<tr><td>Face Direction</td><td>The default direction that the NPC will look before they start their movement.</td><td>uint16_t</td></tr>
<tr><td>Parameter 1</td><td>An optional parameter, whose value purpose depends on the actor's movement code.</td><td>uint16_t</td></tr>
<tr><td>Parameter 2</td><td>An optional parameter, whose value purpose depends on the actor's movement code.</td><td>uint16_t</td></tr>
<tr><td>Parameter 3</td><td>An optional parameter, whose value purpose depends on the actor's movement code.</td><td>uint16_t</td></tr>
<tr><td>Traversal Width</td><td>How far the NPC will travel from left to right, in game units.</td><td>uint16_t</td></tr>
<tr><td>Traversal Height</td><td>How far the NPC will travel up and down, in game units.</td><td>uint16_t</td></tr>
<tr><td>Coordinate System</td><td>If this value is 1, then RailSystem (the system for nonlinear collisions) is used. Otherwise, it is the grid system.</td><td>uint32_t</td></tr>
<tr><td>X</td><td>The world X position of the NPC.</td><td>uint16_t</td></tr>
<tr><td>Z</td><td>The world Z position of the NPC.</td><td>uint16_t</td></tr>
<tr><td>RailSystem Side Position</td><td>If the coordinate system is RailSystem, then this specifies the NPC's side position.</td><td>uint16_t</td></tr>
<tr><td>Y</td><td>The world Y position of this NPC.</td><td>int16_t</td></tr>
</tbody></table>
</div>
<h2 id="warp-entry"><a class="header" href="#warp-entry">Warp Entry</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Field Name</th><th>Description</th><th>Data Type</th></tr></thead><tbody>
<tr><td>Target Zone</td><td>The map header where this warp will teleport you to.</td><td>uint16_t</td></tr>
<tr><td>Target Warp</td><td>The warp where you will be teleported to.</td><td>uint16_t</td></tr>
<tr><td>Contact Direction</td><td>The direction you need to interact with the warp.</td><td>uint8_t</td></tr>
<tr><td>Transition Type</td><td>The transition that will be played when warping.</td><td>uint8_t</td></tr>
<tr><td>Coordinate Type</td><td>The type of coordinates you will be passing in.</td><td>uint16_t</td></tr>
<tr><td>X</td><td>The world X position of the warp.</td><td>uint16_t</td></tr>
<tr><td>Z</td><td>The world Z position of the warp.</td><td>int16_t</td></tr>
<tr><td>Y</td><td>The world Y position of the warp.</td><td>uint16_t</td></tr>
<tr><td>Width</td><td>The width of the warp zone, in game units.</td><td>uint16_t</td></tr>
<tr><td>Height</td><td>The height of the warp zone, in game units.</td><td>uint16_t</td></tr>
<tr><td>Coordinate System</td><td>If this value is 1, then the coordinates are based on RailSystem. Otherwise, it uses the grid system.</td><td>uint16_t</td></tr>
</tbody></table>
</div>
<h2 id="trigger-entry"><a class="header" href="#trigger-entry">Trigger Entry</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Field Name</th><th>Description</th><th>Data Type</th></tr></thead><tbody>
<tr><td>Script ID</td><td>The script ID which will be used when the trigger is executed.</td><td>uint16_t</td></tr>
<tr><td>Work Reference Value</td><td>The value that must be in the work in order for this trigger to execute.</td><td>uint16_t</td></tr>
<tr><td>Work</td><td>The variable that is being monitored for the value we want.</td><td>uint16_t</td></tr>
<tr><td>Unknown</td><td>The purpose of this field has yet to be discovered.</td><td>uint16_t</td></tr>
<tr><td>Unknown 2</td><td>The purpose of this field has yet to be discovered.</td><td>uint16_t</td></tr>
<tr><td>X</td><td>The world X position of the trigger.</td><td>uint16_t</td></tr>
<tr><td>Z</td><td>The world Z position of the trigger.</td><td>uint16_t</td></tr>
<tr><td>Width</td><td>The width of the trigger area.</td><td>uint16_t</td></tr>
<tr><td>Height</td><td>The height of the trigger area.</td><td>uint16_t</td></tr>
<tr><td>Y</td><td>The world Y position of the trigger.</td><td>int16_t</td></tr>
<tr><td>Unknown 3</td><td>The purpose of this field has yet to be discovered.</td><td>uint16_t</td></tr>
</tbody></table>
</div>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </body>
</html>
